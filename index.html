<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é€Ÿæˆå¤§å†’éšª | Quick Input Adventure V8</title>
    
    <!-- Core Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand': { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7' },
                        'magic': { 900: '#2e1065', 800: '#4c1d95', 600: '#7c3aed', 500: '#8b5cf6', 300: '#c4b5fd', 100: '#ede9fe' },
                        'danger': { 900: '#450a0a', 500: '#ef4444' }
                    },
                    fontFamily: {
                        'serif': ['"Noto Serif TC"', '"Songti TC"', 'serif'],
                        'sans': ['"Noto Sans TC"', 'sans-serif'],
                        'mono': ['"Noto Sans Mono"', 'monospace'],
                    },
                    animation: {
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'damage-flash': 'damageFlash 0.3s ease-in-out',
                        'float-up': 'floatUp 1s ease-out forwards',
                    },
                    keyframes: {
                        shake: { '10%, 90%': { transform: 'translate3d(-2px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(4px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-6px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(6px, 0, 0)' } },
                        pulseGlow: { '0%, 100%': { opacity: 1, filter: 'brightness(1)' }, '50%': { opacity: 0.8, filter: 'brightness(1.3)' } },
                        damageFlash: { '0%, 100%': { backgroundColor: 'transparent' }, '50%': { backgroundColor: 'rgba(239, 68, 68, 0.3)' } },
                        floatUp: { '0%': { transform: 'translateY(0) scale(1)', opacity: 1 }, '100%': { transform: 'translateY(-50px) scale(1.5)', opacity: 0 } }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Noto+Serif+TC:wght@700&display=swap');
        html, body, #root { height: 100%; margin: 0; padding: 0; font-family: 'Noto Sans TC', sans-serif; overflow: hidden; touch-action: manipulation; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .keyboard-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { motion, AnimatePresence } = window.Motion;
        const { icons } = lucide;
        const { 
            Settings, Volume2, ArrowLeft, Play, User, Trophy, Star, Zap, LayoutGrid, Rocket, Heart, AlertTriangle, 
            CheckCircle, RefreshCw, Keyboard, MousePointer2, Box, Home, Trees, Cloud, Moon, Flag, Timer, Leaf, 
            Smile, Coffee, BookOpen, Sword, Shield, Ghost, Sparkles, Skull, Flame, Plus, Crown, Gift, Hammer, 
            Droplets, Wind, Eye, Save, Upload, Download, X, Coins, GraduationCap
        } = icons;

        const LucideIcon = ({ icon, size = 24, className = "" }) => icon ? <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icon.map(([tag, attrs], i) => React.createElement(tag, { ...attrs, key: i }))}</svg> : null;

        // --- ğŸµ Audio Engine ---
        const AudioEngine = {
            ctx: null,
            init: function() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            playTone: function(freq, type, duration, vol = 0.1) {
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            },
            correct: function() { this.playTone(880, 'sine', 0.1); setTimeout(() => this.playTone(1760, 'sine', 0.2), 100); },
            wrong: function() { this.playTone(150, 'sawtooth', 0.3); setTimeout(() => this.playTone(100, 'sawtooth', 0.4), 150); },
            click: function() { this.playTone(400, 'triangle', 0.05, 0.05); },
            attack: function() { this.playTone(100, 'square', 0.1, 0.3); setTimeout(() => this.playTone(50, 'sawtooth', 0.2, 0.3), 50); }, 
            crit: function() { this.playTone(600, 'square', 0.1, 0.4); setTimeout(() => this.playTone(1200, 'square', 0.2, 0.4), 100); }, 
            hit: function() { this.playTone(80, 'sawtooth', 0.2, 0.3); },
            skill: function() { [300, 400, 500].forEach((f, i) => setTimeout(() => this.playTone(f, 'sine', 0.2), i * 50)); },
            levelUp: function() { [440, 554, 659, 880, 1108].forEach((f, i) => setTimeout(() => this.playTone(f, 'triangle', 0.3), i * 100)); },
            win: function() { [523, 659, 784, 1046].forEach((f, i) => setTimeout(() => this.playTone(f, 'square', 0.2), i * 150)); },
            lose: function() { [300, 250, 200].forEach((f, i) => setTimeout(() => this.playTone(f, 'sawtooth', 0.3), i * 300)); }
        };

        // --- ğŸ“š Data & Utils ---
        const KEYBOARD_MAP = { 'A': 'æ—¥', 'B': 'æœˆ', 'C': 'é‡‘', 'D': 'æœ¨', 'E': 'æ°´', 'F': 'ç«', 'G': 'åœŸ', 'H': 'ç«¹', 'I': 'æˆˆ', 'J': 'å', 'K': 'å¤§', 'L': 'ä¸­', 'M': 'ä¸€', 'N': 'å¼“', 'O': 'äºº', 'P': 'å¿ƒ', 'Q': 'æ‰‹', 'R': 'å£', 'S': 'å°¸', 'T': 'å»¿', 'U': 'å±±', 'V': 'å¥³', 'W': 'ç”°', 'X': 'é›£', 'Y': 'åœ', 'Z': 'é‡' };
        
        const QUESTIONS = [
            { category: "nature", char: "æ˜", code: "AB", first: "A", last: "B", hint: "æ—¥æœˆç‚ºæ˜", decoys: [{char:"æœ¨",code:"D"}, {char:"ç›®",code:"BU"}, {char:"ç”°",code:"W"}] },
            { category: "nature", char: "æ—", code: "DD", first: "D", last: "D", hint: "é›™æœ¨æˆæ—", decoys: [{char:"æ°´",code:"E"}, {char:"ç«",code:"F"}, {char:"å¤§",code:"K"}] },
            { category: "nature", char: "æ—©", code: "AJ", first: "A", last: "J", hint: "å¤ªé™½å‡ºä¾†åé»äº†", decoys: [{char:"å£",code:"R"}, {char:"ç”°",code:"W"}, {char:"ç”²",code:"WL"}] },
            { category: "nature", char: "èŠ±", code: "TP", first: "T", last: "P", hint: "è‰(å»¿)å­—é ­ï¼Œè®ŠåŒ–(åŒ–)çš„å¿ƒ", decoys: [{char:"æœ¨",code:"D"}, {char:"è‰",code:"TA"}, {char:"ç«",code:"F"}] },
            { category: "nature", char: "æµ·", code: "EY", first: "E", last: "Y", hint: "æ°´(E)æµé€²æ¯(OWY)å€‹è§’è½", decoys: [{char:"æ²³",code:"EMR"}, {char:"æ´‹",code:"ETQ"}, {char:"æ³³",code:"EINO"}] },
            { category: "nature", char: "æ˜Ÿ", code: "AM", first: "A", last: "M", hint: "æ—¥(A)ç”Ÿ(AHM)è¬ç‰©", decoys: [{char:"æ™¶",code:"AAA"}, {char:"æ™¨",code:"AMMV"}, {char:"å…‰",code:"FMU"}] },
            { category: "nature", char: "å¤©", code: "MK", first: "M", last: "K", hint: "ä¸€(M)å¤§(K)ç‰‡å¤©ç©º", decoys: [{char:"å¤«",code:"QO"}, {char:"å¤­",code:"HK"}, {char:"å¤ª",code:"KI"}] },
            { category: "nature", char: "åœ°", code: "GD", first: "G", last: "D", hint: "åœŸ(G)åœ°ä¹Ÿ(PD)æ˜¯å®¶", decoys: [{char:"æ± ",code:"EPD"}, {char:"ä»–",code:"OPD"}, {char:"å ´",code:"GASH"}] },
            { category: "people", char: "æƒ³", code: "DP", first: "D", last: "P", hint: "æœ¨ç›®åœ¨å¿ƒä¸Š", decoys: [{char:"æ‰‹",code:"Q"}, {char:"æ°´",code:"E"}, {char:"æ—¥",code:"A"}] },
            { category: "people", char: "å¥½", code: "VND", first: "V", last: "D", hint: "å¥³å­ç‚ºå¥½", decoys: [{char:"ç”·",code:"WKS"}, {char:"ä¸­",code:"L"}, {char:"å¤§",code:"K"}] },
            { category: "people", char: "ä¼‘", code: "OD", first: "O", last: "D", hint: "äºº(O)é åœ¨æœ¨(D)æ—ä¼‘æ¯", decoys: [{char:"ç«",code:"F"}, {char:"æ°´",code:"E"}, {char:"åœŸ",code:"G"}] },
            { category: "people", char: "ä½ ", code: "OF", first: "O", last: "F", hint: "äºº(O)çˆ¾(NF)ç›¸é‡", decoys: [{char:"æˆ‘",code:"HI"}, {char:"ä»–",code:"OD"}, {char:"ä¼Š",code:"OSK"}] },
            { category: "people", char: "æˆ‘", code: "HI", first: "H", last: "I", hint: "æ‰‹(Q)æŒæˆˆ(I)ä¿è­·è‡ªå·±", decoys: [{char:"æ‰¾",code:"QI"}, {char:"éŒ¢",code:"CII"}, {char:"ä»£",code:"OIP"}] },
            { category: "life", char: "åƒ", code: "RN", first: "R", last: "N", hint: "å£(R)ä¹(ON)æ±‚é£Ÿç‰©", decoys: [{char:"æ‰‹",code:"Q"}, {char:"è¶³",code:"RYO"}, {char:"ç›®",code:"BU"}] },
            { category: "life", char: "å–", code: "RV", first: "R", last: "V", hint: "å£(R)æ¸´(APV)å–æ°´", decoys: [{char:"æ—¥",code:"A"}, {char:"æœˆ",code:"B"}, {char:"ç”°",code:"W"}] },
            { category: "life", char: "ç©", code: "MU", first: "M", last: "U", hint: "ç‹(MG)å…ƒ(MMKU)æ°£", decoys: [{char:"åœŸ",code:"G"}, {char:"é‡‘",code:"C"}, {char:"ç«",code:"F"}] },
            { category: "life", char: "æ›¸", code: "LA", first: "L", last: "A", hint: "è¿(LG)æ—¥(A)ç‚ºæ›¸", decoys: [{char:"ç•«",code:"LGW"}, {char:"ç­†",code:"HLQ"}, {char:"çœ‹",code:"HBU"}] },
            { category: "life", char: "å®¶", code: "JO", first: "J", last: "O", hint: "å®€(J)ä¸‹æœ‰è±•(MSO)", decoys: [{char:"å®‰",code:"JV"}, {char:"å®š",code:"JMO"}, {char:"å®¤",code:"JMIG"}] },
        ];

        const CATEGORIES = [
            { id: 'all', name: 'å…¨éƒ¨', icon: Star, color: 'bg-purple-100 text-purple-600' },
            { id: 'nature', name: 'è‡ªç„¶', icon: Leaf, color: 'bg-green-100 text-green-600' },
            { id: 'people', name: 'äººç‰©', icon: Smile, color: 'bg-amber-100 text-amber-600' },
            { id: 'life', name: 'ç”Ÿæ´»', icon: Coffee, color: 'bg-blue-100 text-blue-600' },
        ];

        // ğŸ›¡ï¸ Enhanced Roguelike Artifacts
        const RPG_ARTIFACTS = [
            // Tier 1 (Common)
            { id: 'wand_1', name: 'å­¸å¾’æ³•æ–', type: 'weapon', val: 5, tier: 1, icon: Zap, desc: 'æ”»æ“ŠåŠ› +5', effect: (p) => ({ ...p, atk: p.atk + 5 }) },
            { id: 'robe_1', name: 'å¸ƒè¡£', type: 'armor', val: 20, tier: 1, icon: Shield, desc: 'æœ€å¤§ HP +20', effect: (p) => ({ ...p, maxHp: p.maxHp + 20, hp: p.hp + 20 }) },
            { id: 'ring_1', name: 'åŠ›é‡æˆ’æŒ‡', type: 'accessory', val: 10, tier: 1, icon: Star, desc: 'æ”»æ“ŠåŠ› +10', effect: (p) => ({ ...p, atk: p.atk + 10 }) },
            { id: 'boots_1', name: 'è¼•éˆä¹‹é´', type: 'accessory', val: 0.05, tier: 1, icon: Wind, desc: 'é–ƒé¿ç‡ +5%', effect: (p) => ({ ...p, dodge: p.dodge + 0.05 }) },
            // Tier 2 (Rare)
            { id: 'vamp_tooth', name: 'å¸è¡€é¬¼ä¹‹ç‰™', type: 'special', val: 0.1, tier: 2, icon: Droplets, desc: 'å¸è¡€ +10%', effect: (p) => ({ ...p, lifesteal: p.lifesteal + 0.1 }) },
            { id: 'sharp_stone', name: 'é›·ç¥ç£¨åˆ€çŸ³', type: 'special', val: 0.2, tier: 2, icon: Zap, desc: 'æš´æ“Šç‡ +20%', effect: (p) => ({ ...p, critChance: p.critChance + 0.2 }) },
            { id: 'spike_shield', name: 'èŠæ£˜ç›¾ç‰Œ', type: 'special', val: 0.2, tier: 2, icon: Shield, desc: 'åå‚· +20%', effect: (p) => ({ ...p, thorns: p.thorns + 0.2, maxHp: p.maxHp + 30 }) },
            { id: 'hourglass', name: 'æ™‚å…‰æ²™æ¼', type: 'special', val: 1, tier: 2, icon: Timer, desc: 'æŠ€èƒ½å†·å» -1å›åˆ', effect: (p) => ({ ...p, cdr: p.cdr + 1 }) },
            // Tier 3 (Legendary)
            { id: 'cursed_mask', name: 'è©›å’’é¢å…·', type: 'special', val: 0, tier: 3, icon: Skull, desc: 'æ”»æ“ŠåŠ› +50%, æœ€å¤§ HP -20%', effect: (p) => ({ ...p, atk: Math.floor(p.atk * 1.5), maxHp: Math.floor(p.maxHp * 0.8), hp: Math.min(p.hp, Math.floor(p.maxHp * 0.8)) }) },
            { id: 'titan_heart', name: 'æ³°å¦ä¹‹å¿ƒ', type: 'special', val: 0, tier: 3, icon: Heart, desc: 'æœ€å¤§ HP +100', effect: (p) => ({ ...p, maxHp: p.maxHp + 100, hp: p.hp + 100 }) },
            { id: 'greedy_pot', name: 'è²ªå©ªä¹‹å£º', type: 'special', val: 0, tier: 3, icon: Coins, desc: 'ç²å¾— 100 EXP', effect: (p) => ({ ...p, exp: p.exp + 100 }) },
        ];

        // ğŸ‘¾ Monster Scaling
        const MONSTER_TYPES = [
            { name: 'å²èŠå§†', hpMod: 0.8, atkMod: 0.8, speedMod: 0.8, color: 'text-green-400', icon: Ghost },
            { name: 'è™è ', hpMod: 0.6, atkMod: 1.2, speedMod: 1.5, color: 'text-purple-400', icon: Wind },
            { name: 'çŸ³åƒé¬¼', hpMod: 1.5, atkMod: 1.0, speedMod: 0.6, color: 'text-stone-400', icon: Shield },
            { name: 'æš—å½±åˆºå®¢', hpMod: 0.8, atkMod: 1.5, speedMod: 1.2, color: 'text-red-400', icon: Sword },
            // Bosses
            { name: 'å­—éˆé¾', hpMod: 2.5, atkMod: 1.5, speedMod: 1.0, color: 'text-yellow-400', icon: Crown, isBoss: true },
            { name: 'æ·±æ·µé ˜ä¸»', hpMod: 3.0, atkMod: 1.8, speedMod: 0.8, color: 'text-rose-500', icon: Skull, isBoss: true },
        ];

        // --- âš”ï¸ RPG Game Component ---
        const RPGGame = ({ difficulty, category, onExit, onHome, onLoadGame, initialData }) => {
            // Player State
            const [player, setPlayer] = useState(initialData?.player || {
                hp: 100, maxHp: 100, atk: 20, level: 1, exp: 0, maxExp: 100,
                critChance: 0.1, critMult: 1.5, lifesteal: 0, thorns: 0, dodge: 0, shield: 0, cdr: 0,
                bonusDmg: 0, combo: 0,
                skills: [{ id: 'heal', name: 'æ²»ç™’è¡“', baseCd: 4, currentCd: 0, icon: Heart, color: 'bg-green-500' }, { id: 'burst', name: 'çˆ†è£‚é­”æ³•', baseCd: 6, currentCd: 0, icon: Flame, color: 'bg-red-500' }, { id: 'guard', name: 'éµå£', baseCd: 5, currentCd: 0, icon: Shield, color: 'bg-blue-500' }],
                artifacts: [],
                floor: 1
            });
            
            const [monster, setMonster] = useState({ hp: 100, maxHp: 100, name: 'äº‚ç¢¼æ€ªç¸', type: MONSTER_TYPES[0] });
            const [attackGauge, setAttackGauge] = useState(0); 
            const [qIndex, setQIndex] = useState(0);
            const [turn, setTurn] = useState('player'); 
            const [userInput, setUserInput] = useState([]);
            const [combatLog, setCombatLog] = useState("æˆ°é¬¥é–‹å§‹ï¼");
            const [animation, setAnimation] = useState(null); 
            const [rewards, setRewards] = useState([]); 
            const [showStats, setShowStats] = useState(false);

            // Init Monster (Scale with floor)
            useEffect(() => {
                if (!initialData) spawnMonster();
            }, []);

            const spawnMonster = () => {
                const isBoss = player.floor % 5 === 0;
                const pool = MONSTER_TYPES.filter(m => isBoss ? m.isBoss : !m.isBoss);
                const type = pool[Math.floor(Math.random() * pool.length)];
                
                // Scaling Formula: Base * (1 + Floor * 0.15)
                const scale = 1 + (player.floor * 0.15);
                const hp = Math.floor(100 * type.hpMod * scale);
                const name = `${isBoss ? 'ã€BOSSã€‘' : ''}${type.name} (Lv.${player.floor})`;
                
                setMonster({ hp: hp, maxHp: hp, name: name, type: type });
                setAttackGauge(0);
                setCombatLog(`é­é‡ ${name}ï¼`);
            };

            const filteredQuestions = useMemo(() => {
                if (category === 'all') return QUESTIONS;
                return QUESTIONS.filter(q => q.category === category);
            }, [category]);
            
            // Random question pool logic
            const currentQ = useMemo(() => {
                return filteredQuestions[Math.floor(Math.random() * filteredQuestions.length)];
            }, [qIndex, category]);

            // Save Game Function
            const saveGame = () => {
                const saveData = {
                    player,
                    difficulty,
                    date: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(saveData)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `word_battler_save_lv${player.level}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                setCombatLog("éŠæˆ²é€²åº¦å·²å„²å­˜ï¼");
            };

            // Monster Logic
            useEffect(() => {
                let interval;
                if (turn === 'player') {
                    interval = setInterval(() => {
                        setAttackGauge(prev => {
                            if (prev >= 100) {
                                const baseDmg = 10 + (player.floor * 2);
                                const finalDmg = Math.floor(baseDmg * monster.type.atkMod);
                                handlePlayerDamage(finalDmg, `${monster.type.name} æ”»æ“Šï¼`);
                                return 0;
                            }
                            let increment = 2.5 * monster.type.speedMod;
                            if (difficulty === 'intermediate') increment *= 0.7;
                            if (difficulty === 'advanced') increment *= 0.3; 
                            return prev + increment;
                        });
                    }, 200);
                }
                return () => clearInterval(interval);
            }, [turn, difficulty, monster, player.floor]);

            // Handlers
            const handlePlayerDamage = (rawDmg, reason) => {
                if (Math.random() < player.dodge) { setCombatLog(`${reason} MISS!`); return; }
                AudioEngine.hit();
                setAnimation('damage');
                let damage = Math.max(0, rawDmg - player.shield);
                const remainingShield = Math.max(0, player.shield - rawDmg);
                
                if (player.thorns > 0) {
                    const thornsDmg = Math.floor(rawDmg * player.thorns);
                    setMonster(m => ({ ...m, hp: Math.max(0, m.hp - thornsDmg) }));
                }

                setPlayer(p => ({ ...p, hp: Math.max(0, p.hp - damage), shield: remainingShield, combo: 0 }));
                setCombatLog(`${reason} å—åˆ° ${damage} å‚·å®³ï¼`);
                setTimeout(() => { setAnimation(null); if (player.hp - damage <= 0) { setTurn('lose'); AudioEngine.lose(); } }, 300);
            };

            const resolvePlayerAttack = () => {
                const comboMult = 1 + (player.combo * 0.1);
                let damage = (player.atk + player.bonusDmg) * comboMult;
                let isCrit = Math.random() < player.critChance;
                if (isCrit) { damage *= player.critMult; AudioEngine.crit(); } else AudioEngine.attack();
                damage = Math.floor(damage);

                if (player.lifesteal > 0) setPlayer(p => ({ ...p, hp: Math.min(p.maxHp, p.hp + Math.floor(damage * player.lifesteal)) }));

                setPlayer(p => ({ 
                    ...p, bonusDmg: 0, combo: p.combo + 1,
                    skills: p.skills.map(s => ({ ...s, currentCd: Math.max(0, s.currentCd - 1) }))
                })); 
                
                setMonster(m => ({ ...m, hp: Math.max(0, m.hp - damage) }));
                setCombatLog(`${isCrit ? 'æœƒå¿ƒï¼' : 'å‘½ä¸­ï¼'} -${damage}`);
                setAttackGauge(prev => Math.max(0, prev - 10));

                if (monster.hp - damage <= 0) setTimeout(handleMonsterDefeat, 600);
                else setTimeout(() => setUserInput([]), 600);
            };

            const handleSkill = (skillId) => {
                if (turn !== 'player') return;
                const idx = player.skills.findIndex(s => s.id === skillId);
                const skill = player.skills[idx];
                if (skill.currentCd > 0) return;

                AudioEngine.skill();
                const updatedSkills = [...player.skills];
                // Apply CDR from artifacts
                const cooldown = Math.max(1, skill.baseCd - player.cdr);
                updatedSkills[idx] = { ...skill, currentCd: cooldown };

                // Hardcoded skill effects to avoid serialization issues
                let newP = { ...player, skills: updatedSkills };
                let log = '';
                
                if (skill.id === 'heal') {
                    const healAmt = Math.floor(newP.maxHp * 0.3);
                    newP.hp = Math.min(newP.maxHp, newP.hp + healAmt);
                    log = `å›å¾© ${healAmt} HP`;
                } else if (skill.id === 'burst') {
                    newP.bonusDmg = newP.atk * 2;
                    log = 'ä¸‹æ“Šå‚·å®³ 200%';
                } else if (skill.id === 'guard') {
                    newP.shield += 50;
                    log = 'è­·ç›¾ +50';
                }

                setPlayer(newP);
                setCombatLog(log);
                setAnimation('heal');
                setTimeout(() => setAnimation(null), 800);
            };

            const handleMonsterDefeat = () => {
                AudioEngine.levelUp();
                let newExp = player.exp + 50 + (player.floor * 10);
                let newLevel = player.level;
                let newMaxExp = player.maxExp;
                let leveledUp = false;

                if (newExp >= player.maxExp) {
                    newExp -= player.maxExp;
                    newLevel++;
                    newMaxExp = Math.floor(newMaxExp * 1.2);
                    leveledUp = true;
                }

                setPlayer(p => ({
                    ...p, exp: newExp, level: newLevel, maxExp: newMaxExp,
                    maxHp: leveledUp ? p.maxHp + 10 : p.maxHp,
                    atk: leveledUp ? p.atk + 2 : p.atk,
                    hp: leveledUp ? p.maxHp : p.hp,
                    floor: p.floor + 1
                }));

                const pool = RPG_ARTIFACTS.sort(() => 0.5 - Math.random()).slice(0, 3);
                setRewards(pool);
                setTurn('reward');
            };

            const handleSelectReward = (reward) => {
                AudioEngine.correct();
                // Execute effect
                const newP = reward.effect(player);
                // Clean artifact for storage (remove function)
                const safeArtifact = { id: reward.id, name: reward.name, icon: reward.icon, desc: reward.desc };
                setPlayer({ ...newP, artifacts: [...newP.artifacts, safeArtifact] });

                setQIndex(q => q + 1);
                spawnMonster();
                setUserInput([]);
                setTurn('player');
            };

            const renderInput = () => {
                if (difficulty === 'advanced') {
                    const keys = "QWERTYUIOPASDFGHJKLZXCVBNM".split('');
                    const handleKeyClick = (key) => {
                        if (turn !== 'player') return;
                        if (userInput.length === 0) {
                            if (key === currentQ.first) { AudioEngine.click(); setUserInput([key]); }
                            else { handlePlayerDamage(5, "é¦–ç¢¼éŒ¯èª¤"); setUserInput([]); }
                        } else if (userInput.length === 1) {
                            if (key === currentQ.last) { setUserInput([...userInput, key]); resolvePlayerAttack(); }
                            else { handlePlayerDamage(5, "å°¾ç¢¼éŒ¯èª¤"); }
                        }
                    };
                    // Physical KB
                    useEffect(() => {
                        const h = (e) => { const k = e.key.toUpperCase(); if(/^[A-Z]$/.test(k)) handleKeyClick(k); };
                        window.addEventListener('keydown', h); return () => window.removeEventListener('keydown', h);
                    }, [currentQ, userInput, turn]);

                    return (
                        <div className="w-full max-w-3xl mx-auto p-2">
                            <div className="flex justify-center mb-4 space-x-2">
                                <div className={`w-12 h-12 border-2 rounded flex items-center justify-center text-2xl font-bold bg-slate-800 border-magic-500 text-magic-300`}>{userInput[0] && KEYBOARD_MAP[userInput[0]]}</div>
                                <div className={`w-12 h-12 border-2 rounded flex items-center justify-center text-2xl font-bold bg-slate-800 border-magic-500 text-magic-300`}>{userInput[1] && KEYBOARD_MAP[userInput[1]]}</div>
                            </div>
                            <div className="keyboard-grid">{keys.map(k => <button key={k} onClick={() => handleKeyClick(k)} className="aspect-square bg-slate-800 border border-slate-700 rounded flex flex-col items-center justify-center hover:bg-slate-700"><span className="text-xs text-slate-500">{k}</span><span className="text-magic-300 font-bold">{KEYBOARD_MAP[k]}</span></button>)}</div>
                        </div>
                    );
                } 
                
                // Card Options
                const currentOptions = useMemo(() => {
                    if (difficulty === 'advanced') return [];
                    const correct = difficulty === 'beginner' 
                        ? { label: `${KEYBOARD_MAP[currentQ.first]} (${currentQ.first})`, val: currentQ.first, isCorrect: true }
                        : { label: `${KEYBOARD_MAP[currentQ.first]} + ${KEYBOARD_MAP[currentQ.last]}`, val: currentQ.code, isCorrect: true };
                    const decoys = currentQ.decoys.slice(0, 2).map(d => {
                        if (difficulty === 'beginner') return { label: `${d.char} (${d.code[0]})`, val: d.code[0], isCorrect: false };
                        return { label: `${d.char} (${d.code[0]}+${d.code[d.code.length-1]})`, val: d.code[0]+d.code[d.code.length-1], isCorrect: false };
                    });
                    return [correct, ...decoys].sort(() => Math.random() - 0.5);
                }, [currentQ, difficulty]);

                const handleCardClick = (val) => {
                    if (turn !== 'player') return;
                    const isCorrect = (difficulty === 'beginner' && val === currentQ.first) || (difficulty === 'intermediate' && val === currentQ.code);
                    if (isCorrect) resolvePlayerAttack(); else handlePlayerDamage(5, "é¸éŒ¯äº†ï¼");
                };

                return <div className="grid grid-cols-3 gap-4 max-w-2xl mx-auto">{currentOptions.map((o,i) => <button key={i} onClick={() => handleCardClick(o.val)} className="bg-slate-800 border-2 border-magic-500 py-6 rounded-xl text-xl font-bold text-magic-300 hover:bg-slate-700">{o.label}</button>)}</div>;
            };

            if (turn === 'lose') return <div className="absolute inset-0 bg-slate-950 flex flex-col items-center justify-center text-white p-8"><LucideIcon icon={Skull} size={80} className="text-red-500 mb-6" /><h2 className="text-4xl font-bold mb-2 text-red-500">YOU DIED</h2><p className="mb-8">æ­¢æ­¥æ–¼ç¬¬ {player.floor} å±¤</p><button onClick={onHome} className="bg-red-600 px-8 py-3 rounded-full font-bold">è¿”å›ä¸»é </button></div>;

            if (turn === 'reward') return (
                <div className="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center text-white p-4 z-50">
                    <h2 className="text-3xl font-bold text-yellow-400 mb-8 animate-bounce">æˆ°åˆ©å“é¸æ“‡</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-5xl w-full">
                        {rewards.map((r, i) => (
                            <button key={i} onClick={() => handleSelectReward(r)} className="bg-slate-800 border-2 border-magic-600 hover:scale-105 transition-transform p-6 rounded-2xl flex flex-col items-center shadow-2xl">
                                <LucideIcon icon={r.icon} size={48} className="text-yellow-400 mb-4" />
                                <h3 className="text-xl font-bold mb-2">{r.name}</h3>
                                <p className="text-sm text-slate-300">{r.desc}</p>
                            </button>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className={`h-full w-full flex flex-col bg-slate-950 text-white font-sans relative overflow-hidden ${animation === 'damage' ? 'animate-damage-flash' : ''}`}>
                    {/* Header */}
                    <div className="p-3 bg-slate-900/90 border-b border-slate-800 flex justify-between items-center z-10">
                        <div className="flex items-center gap-4 cursor-pointer" onClick={() => setShowStats(!showStats)}>
                            <div className="w-12 h-12 bg-magic-700 rounded-lg flex flex-col items-center justify-center border-2 border-magic-500">
                                <span className="text-xs">LV</span><span className="font-bold text-xl">{player.level}</span>
                            </div>
                            <div>
                                <div className="text-xs text-slate-400">Floor {player.floor}</div>
                                <div className="w-32 h-3 bg-slate-800 rounded-full overflow-hidden relative"><div className="h-full bg-red-500" style={{width: `${(player.hp/player.maxHp)*100}%`}}></div>{player.shield>0 && <div className="absolute top-0 h-full bg-blue-400/50" style={{width: `${(player.shield/player.maxHp)*100}%`}}/>}</div>
                                <div className="text-[10px] text-right">{player.hp}/{player.maxHp}</div>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={saveGame} className="p-2 bg-slate-800 rounded border border-slate-600" title="å„²å­˜é€²åº¦"><LucideIcon icon={Save} size={18}/></button>
                            <button onClick={onHome} className="p-2 bg-red-900 rounded border border-red-700" title="é€€å‡º"><LucideIcon icon={X} size={18}/></button>
                        </div>
                    </div>

                    {/* Stats Overlay */}
                    {showStats && (
                        <div className="absolute top-20 left-4 bg-slate-900/95 border border-slate-700 p-4 rounded-xl z-40 text-sm shadow-xl" onClick={()=>setShowStats(false)}>
                            <h4 className="font-bold border-b border-slate-700 mb-2 pb-1">è§’è‰²å±¬æ€§</h4>
                            <p>âš”ï¸ æ”»æ“Š: {player.atk}</p>
                            <p>âš¡ æš´æ“Š: {Math.round(player.critChance*100)}%</p>
                            <p>ğŸ©¸ å¸è¡€: {Math.round(player.lifesteal*100)}%</p>
                            <p>ğŸ›¡ï¸ åå‚·: {Math.round(player.thorns*100)}%</p>
                            <p>ğŸ’¨ é–ƒé¿: {Math.round(player.dodge*100)}%</p>
                            <h4 className="font-bold border-b border-slate-700 mb-2 pb-1 mt-2">éºç‰©èƒŒåŒ…</h4>
                            <div className="flex flex-wrap gap-1 w-48">
                                {player.artifacts.map((a,i)=><div key={i} title={a.name} className="bg-slate-800 p-1 rounded border border-slate-600"><LucideIcon icon={a.icon} size={14} className="text-yellow-500"/></div>)}
                            </div>
                        </div>
                    )}

                    {/* Arena */}
                    <div className="flex-1 relative flex flex-col items-center justify-center">
                        {/* Skills */}
                        <div className="absolute top-4 flex gap-4 z-20">
                            {player.skills.map(s => (
                                <button key={s.id} onClick={() => handleSkill(s.id)} disabled={s.currentCd > 0} className={`w-14 h-14 rounded-full border-2 flex flex-col items-center justify-center relative transition-transform active:scale-95 ${s.currentCd > 0 ? 'bg-slate-800 border-slate-600 opacity-50' : `${s.color} border-white shadow-lg`}`}>
                                    <LucideIcon icon={s.icon} size={24} className="text-white" />
                                    {s.currentCd > 0 && <div className="absolute inset-0 bg-black/60 rounded-full flex items-center justify-center font-bold text-white">{s.currentCd}</div>}
                                </button>
                            ))}
                        </div>

                        {/* Monster */}
                        <motion.div animate={{ y: [0, -10, 0] }} transition={{ repeat: Infinity, duration: 3 }} className="relative z-10 mt-8 mb-4">
                            <div className="w-40 h-40 bg-slate-800 rounded-full border-4 border-magic-500 flex items-center justify-center shadow-[0_0_30px_rgba(139,92,246,0.4)]">
                                <LucideIcon icon={monster.type.icon} size={80} className={monster.type.color} />
                                <span className="absolute text-7xl font-serif font-black text-white drop-shadow-md">{currentQ.char}</span>
                            </div>
                            {/* ATB Bar */}
                            <div className="absolute -bottom-6 left-1/2 transform -translate-x-1/2 w-32 h-2 bg-slate-800 rounded-full overflow-hidden border border-slate-600">
                                <motion.div className="h-full bg-red-500" style={{ width: `${attackGauge}%` }} transition={{ ease: 'linear', duration: 0.2 }} />
                            </div>
                            <div className="absolute -top-8 w-full text-center text-red-400 font-bold text-sm">{monster.name}</div>
                        </motion.div>

                        <div className="text-center h-8 font-bold text-lg text-magic-200">{combatLog}</div>
                    </div>

                    {/* Input Area */}
                    <div className="bg-slate-900 border-t border-slate-800 p-6 rounded-t-3xl shadow-2xl">
                        <div className="max-w-4xl mx-auto text-center">{renderInput()}</div>
                    </div>
                </div>
            );
        };

        // --- ğŸ  App Component ---
        const App = () => {
            const [view, setView] = useState('home'); 
            const [userName, setUserName] = useState('');
            const [saveData, setSaveData] = useState(null);
            const [config, setConfig] = useState({ difficulty: 'beginner', category: 'all' });

            const handleLoadGame = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        setSaveData(data);
                        setUserName(data.player.name || "ç©å®¶"); // Simplified
                        setConfig({ difficulty: data.difficulty, category: 'all' });
                        setView('game_rpg_load');
                    } catch (err) {
                        alert("å­˜æª”è®€å–å¤±æ•—ï¼");
                    }
                };
                reader.readAsText(file);
            };

            const goHome = () => setView('home');

            if (view === 'home') {
                return (
                    <div className="h-full w-full bg-brand-50 flex flex-col items-center justify-center p-6">
                        <div className="w-full max-w-md bg-white rounded-3xl shadow-xl p-8 text-center space-y-6">
                            <div className="w-20 h-20 bg-brand-100 rounded-full flex items-center justify-center mx-auto text-brand-600"><LucideIcon icon={Rocket} size={40} /></div>
                            <h1 className="text-3xl font-black text-slate-800">é€Ÿæˆå¤§å†’éšª V8</h1>
                            <p className="text-slate-500">Roguelite RPG x æ‰“å­—ç·´ç¿’</p>
                            
                            <input className="w-full p-4 border-2 rounded-xl text-center text-lg focus:border-brand-500 outline-none" placeholder="è¼¸å…¥åå­—é–‹å§‹" value={userName} onChange={e=>setUserName(e.target.value)} />
                            
                            <button disabled={!userName} onClick={() => { AudioEngine.click(); setView('mode_select'); }} className="w-full bg-brand-500 text-white p-4 rounded-xl font-bold shadow-lg disabled:opacity-50 hover:bg-brand-600 transition-all">
                                <LucideIcon icon={Play} className="inline mr-2" /> é–‹å§‹æ–°éŠæˆ²
                            </button>

                            <div className="relative">
                                <input type="file" id="load-save" className="hidden" onChange={handleLoadGame} accept=".json" />
                                <label htmlFor="load-save" className="block w-full bg-slate-100 text-slate-600 p-4 rounded-xl font-bold cursor-pointer hover:bg-slate-200 transition-all">
                                    <LucideIcon icon={Upload} className="inline mr-2" /> è®€å–é€²åº¦ (JSON)
                                </label>
                            </div>
                        </div>
                        <div className="mt-8 text-slate-400 text-sm">Â© 2025 WMC Education</div>
                    </div>
                );
            }

            if (view === 'mode_select') {
                return (
                    <div className="h-full bg-slate-50 p-6 flex flex-col items-center justify-center">
                        <h2 className="text-2xl font-bold mb-8">é¸æ“‡éŠæˆ²æ¨¡å¼</h2>
                        <div className="grid gap-6 w-full max-w-md">
                            <button onClick={() => setView('category_select')} className="bg-slate-800 text-white p-6 rounded-2xl shadow-xl hover:scale-105 transition-transform flex items-center gap-4">
                                <div className="p-4 bg-purple-600 rounded-full"><LucideIcon icon={Sword} size={32} /></div>
                                <div className="text-left"><h3 className="text-xl font-bold">å­—éˆå¬å–šå¸« (RPG)</h3><p className="text-sm text-slate-400">Roguelike ç„¡é™æŒ‘æˆ°</p></div>
                            </button>
                            <button className="bg-white text-slate-800 p-6 rounded-2xl shadow-xl hover:scale-105 transition-transform flex items-center gap-4 opacity-50 cursor-not-allowed">
                                <div className="p-4 bg-yellow-100 rounded-full"><LucideIcon icon={Zap} size={32} className="text-yellow-600"/></div>
                                <div className="text-left"><h3 className="text-xl font-bold">é€Ÿæˆè·‘é…· (ç¶­è­·ä¸­)</h3><p className="text-sm text-slate-400">å°ˆæ³¨ RPG æ¨¡å¼æ¸¬è©¦</p></div>
                            </button>
                        </div>
                        <button onClick={goHome} className="mt-8 text-slate-400 hover:text-slate-600">è¿”å›ä¸»é </button>
                    </div>
                );
            }

            if (view === 'category_select') {
                return (
                    <div className="h-full bg-slate-50 p-6">
                        <div className="flex justify-between items-center mb-8"><h2 className="text-2xl font-bold">é¸æ“‡é›£åº¦</h2><button onClick={()=>setView('mode_select')}><LucideIcon icon={ArrowLeft} /></button></div>
                        <div className="space-y-4 max-w-md mx-auto">
                            {['beginner', 'intermediate', 'advanced'].map(d => (
                                <button key={d} onClick={()=>{setConfig({...config, difficulty:d}); setView('game_rpg')}} className="w-full p-6 bg-white rounded-2xl shadow-md font-bold text-left flex justify-between hover:bg-brand-50">
                                    <span>{d==='beginner' ? 'ğŸŸ¢ å­¸å¾’ (é¦–ç¢¼)' : d==='intermediate' ? 'ğŸŸ¡ æ³•å¸« (å…¨ç¢¼)' : 'ğŸ”´ è³¢è€… (éµç›¤)'}</span>
                                    <LucideIcon icon={Play} />
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            if (view === 'game_rpg') return <RPGGame user={userName} difficulty={config.difficulty} category="all" onExit={goHome} onHome={goHome} />;
            if (view === 'game_rpg_load') return <RPGGame user={userName} difficulty={config.difficulty} category="all" onExit={goHome} onHome={goHome} initialData={saveData} />;

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
