<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÈÄüÊàêÂ§ßÂÜíÈö™ | Quick Input Adventure V9</title>
    
    <!-- Core Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand': { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7' },
                        'magic': { 950: '#1e1b4b', 900: '#2e1065', 800: '#4c1d95', 600: '#7c3aed', 500: '#8b5cf6', 300: '#c4b5fd', 100: '#ede9fe' },
                        'gold': { 400: '#facc15', 500: '#eab308', 600: '#ca8a04' },
                    },
                    fontFamily: {
                        'serif': ['"Noto Serif TC"', '"Songti TC"', 'serif'],
                        'sans': ['"Noto Sans TC"', 'sans-serif'],
                        'mono': ['"Noto Sans Mono"', 'monospace'],
                    },
                    animation: {
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'damage-flash': 'damageFlash 0.3s ease-in-out',
                        'float-up': 'floatUp 1s ease-out forwards',
                        'coin-spin': 'coinSpin 1s linear infinite',
                    },
                    keyframes: {
                        shake: { '10%, 90%': { transform: 'translate3d(-2px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(4px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-6px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(6px, 0, 0)' } },
                        pulseGlow: { '0%, 100%': { opacity: 1, filter: 'brightness(1)' }, '50%': { opacity: 0.8, filter: 'brightness(1.3)' } },
                        damageFlash: { '0%, 100%': { backgroundColor: 'transparent' }, '50%': { backgroundColor: 'rgba(239, 68, 68, 0.3)' } },
                        floatUp: { '0%': { transform: 'translateY(0) scale(1)', opacity: 1 }, '100%': { transform: 'translateY(-50px) scale(1.5)', opacity: 0 } },
                        coinSpin: { '0%': { transform: 'rotateY(0deg)' }, '100%': { transform: 'rotateY(360deg)' } }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Noto+Serif+TC:wght@700&display=swap');
        html, body, #root { height: 100%; margin: 0; padding: 0; font-family: 'Noto Sans TC', sans-serif; overflow: hidden; touch-action: manipulation; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .keyboard-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { motion, AnimatePresence } = window.Motion;
        const { icons } = lucide;
        const { 
            Settings, Volume2, ArrowLeft, Play, User, Trophy, Star, Zap, LayoutGrid, Rocket, Heart, AlertTriangle, 
            CheckCircle, RefreshCw, Keyboard, MousePointer2, Box, Home, Trees, Cloud, Moon, Flag, Timer, Leaf, 
            Smile, Coffee, BookOpen, Sword, Shield, Ghost, Sparkles, Skull, Flame, Plus, Crown, Gift, Hammer, 
            Droplets, Wind, Eye, Save, Upload, Download, X, Coins, GraduationCap, Lock, Unlock, ShoppingBag
        } = icons;

        const LucideIcon = ({ icon, size = 24, className = "" }) => icon ? <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icon.map(([tag, attrs], i) => React.createElement(tag, { ...attrs, key: i }))}</svg> : null;

        // --- üéµ Audio Engine ---
        const AudioEngine = {
            ctx: null,
            init: function() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            playTone: function(freq, type, duration, vol = 0.1) {
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            },
            correct: function() { this.playTone(880, 'sine', 0.1); setTimeout(() => this.playTone(1760, 'sine', 0.2), 100); },
            wrong: function() { this.playTone(150, 'sawtooth', 0.3); setTimeout(() => this.playTone(100, 'sawtooth', 0.4), 150); },
            click: function() { this.playTone(400, 'triangle', 0.05, 0.05); },
            attack: function() { this.playTone(100, 'square', 0.1, 0.3); setTimeout(() => this.playTone(50, 'sawtooth', 0.2, 0.3), 50); }, 
            crit: function() { this.playTone(600, 'square', 0.1, 0.4); setTimeout(() => this.playTone(1200, 'square', 0.2, 0.4), 100); }, 
            hit: function() { this.playTone(80, 'sawtooth', 0.2, 0.3); },
            skill: function() { [300, 400, 500].forEach((f, i) => setTimeout(() => this.playTone(f, 'sine', 0.2), i * 50)); },
            levelUp: function() { [440, 554, 659, 880, 1108].forEach((f, i) => setTimeout(() => this.playTone(f, 'triangle', 0.3), i * 100)); },
            win: function() { [523, 659, 784, 1046].forEach((f, i) => setTimeout(() => this.playTone(f, 'square', 0.2), i * 150)); },
            lose: function() { [300, 250, 200].forEach((f, i) => setTimeout(() => this.playTone(f, 'sawtooth', 0.3), i * 300)); },
            coin: function() { this.playTone(1200, 'sine', 0.1, 0.1); setTimeout(() => this.playTone(1600, 'sine', 0.2, 0.1), 50); }
        };

        // --- üìö Data & Utils ---
        const KEYBOARD_MAP = { 'A': 'Êó•', 'B': 'Êúà', 'C': 'Èáë', 'D': 'Êú®', 'E': 'Ê∞¥', 'F': 'ÁÅ´', 'G': 'Âúü', 'H': 'Á´π', 'I': 'Êàà', 'J': 'ÂçÅ', 'K': 'Â§ß', 'L': '‰∏≠', 'M': '‰∏Ä', 'N': 'Âºì', 'O': '‰∫∫', 'P': 'ÂøÉ', 'Q': 'Êâã', 'R': 'Âè£', 'S': 'Â∞∏', 'T': 'Âªø', 'U': 'Â±±', 'V': 'Â•≥', 'W': 'Áî∞', 'X': 'Èõ£', 'Y': 'Âçú', 'Z': 'Èáç' };
        
        const QUESTIONS = [
            { category: "nature", char: "Êòé", code: "AB", first: "A", last: "B", hint: "Êó•ÊúàÁÇ∫Êòé", decoys: [{char:"Êú®",code:"D"}, {char:"ÁõÆ",code:"BU"}, {char:"Áî∞",code:"W"}] },
            { category: "nature", char: "Êûó", code: "DD", first: "D", last: "D", hint: "ÈõôÊú®ÊàêÊûó", decoys: [{char:"Ê∞¥",code:"E"}, {char:"ÁÅ´",code:"F"}, {char:"Â§ß",code:"K"}] },
            { category: "nature", char: "Êó©", code: "AJ", first: "A", last: "J", hint: "Â§™ÈôΩÂá∫‰æÜÂçÅÈªû‰∫Ü", decoys: [{char:"Âè£",code:"R"}, {char:"Áî∞",code:"W"}, {char:"Áî≤",code:"WL"}] },
            { category: "nature", char: "Ëä±", code: "TP", first: "T", last: "P", hint: "Ëçâ(Âªø)Â≠óÈ†≠ÔºåËÆäÂåñ(Âåñ)ÁöÑÂøÉ", decoys: [{char:"Êú®",code:"D"}, {char:"Ëçâ",code:"TA"}, {char:"ÁÅ´",code:"F"}] },
            { category: "nature", char: "Êµ∑", code: "EY", first: "E", last: "Y", hint: "Ê∞¥(E)ÊµÅÈÄ≤ÊØè(OWY)ÂÄãËßíËêΩ", decoys: [{char:"Ê≤≥",code:"EMR"}, {char:"Ê¥ã",code:"ETQ"}, {char:"Ê≥≥",code:"EINO"}] },
            { category: "nature", char: "Êòü", code: "AM", first: "A", last: "M", hint: "Êó•(A)Áîü(AHM)Ëê¨Áâ©", decoys: [{char:"Êô∂",code:"AAA"}, {char:"Êô®",code:"AMMV"}, {char:"ÂÖâ",code:"FMU"}] },
            { category: "nature", char: "Â§©", code: "MK", first: "M", last: "K", hint: "‰∏Ä(M)Â§ß(K)ÁâáÂ§©Á©∫", decoys: [{char:"Â§´",code:"QO"}, {char:"Â§≠",code:"HK"}, {char:"Â§™",code:"KI"}] },
            { category: "nature", char: "Âú∞", code: "GD", first: "G", last: "D", hint: "Âúü(G)Âú∞‰πü(PD)ÊòØÂÆ∂", decoys: [{char:"Ê±†",code:"EPD"}, {char:"‰ªñ",code:"OPD"}, {char:"Â†¥",code:"GASH"}] },
            { category: "nature", char: "Èõ®", code: "MY", first: "M", last: "Y", hint: "‰∏Ä(M)Êª¥Êª¥Âçú(Y)‰∏ã‰æÜ", decoys: [{char:"Èõ™",code:"MFSM"}, {char:"Èõ∑",code:"MOW"}, {char:"Èõ≤",code:"MMI"}] },
            { category: "nature", char: "Èõª", code: "MU", first: "M", last: "U", hint: "Èõ®(M)‰∏ãÁöÑÈõª(LBU)ÂÖâ", decoys: [{char:"Áî≥",code:"LWL"}, {char:"Áî≤",code:"WL"}, {char:"Áî∞",code:"W"}] },
            { category: "people", char: "ÊÉ≥", code: "DP", first: "D", last: "P", hint: "Êú®ÁõÆÂú®ÂøÉ‰∏ä", decoys: [{char:"Êâã",code:"Q"}, {char:"Ê∞¥",code:"E"}, {char:"Êó•",code:"A"}] },
            { category: "people", char: "Â•Ω", code: "VND", first: "V", last: "D", hint: "Â•≥Â≠êÁÇ∫Â•Ω", decoys: [{char:"Áî∑",code:"WKS"}, {char:"‰∏≠",code:"L"}, {char:"Â§ß",code:"K"}] },
            { category: "people", char: "‰ºë", code: "OD", first: "O", last: "D", hint: "‰∫∫(O)Èù†Âú®Êú®(D)ÊóÅ‰ºëÊÅØ", decoys: [{char:"ÁÅ´",code:"F"}, {char:"Ê∞¥",code:"E"}, {char:"Âúü",code:"G"}] },
            { category: "people", char: "‰Ω†", code: "OF", first: "O", last: "F", hint: "‰∫∫(O)Áàæ(NF)Áõ∏ÈÅá", decoys: [{char:"Êàë",code:"HI"}, {char:"‰ªñ",code:"OD"}, {char:"‰ºä",code:"OSK"}] },
            { category: "people", char: "Êàë", code: "HI", first: "H", last: "I", hint: "Êâã(Q)ÊåÅÊàà(I)‰øùË≠∑Ëá™Â∑±", decoys: [{char:"Êâæ",code:"QI"}, {char:"Èå¢",code:"CII"}, {char:"‰ª£",code:"OIP"}] },
            { category: "people", char: "‰ªñ", code: "OD", first: "O", last: "D", hint: "‰∫∫(O)‰πü(PD)ÊòØ‰ªñ", decoys: [{char:"Âú∞",code:"GD"}, {char:"Ê±†",code:"EPD"}, {char:"ÊñΩ",code:"XYPD"}] },
            { category: "life", char: "ÂêÉ", code: "RN", first: "R", last: "N", hint: "Âè£(R)‰πû(ON)Ê±ÇÈ£üÁâ©", decoys: [{char:"Êâã",code:"Q"}, {char:"Ë∂≥",code:"RYO"}, {char:"ÁõÆ",code:"BU"}] },
            { category: "life", char: "Âñù", code: "RV", first: "R", last: "V", hint: "Âè£(R)Ê∏¥(APV)ÂñùÊ∞¥", decoys: [{char:"Êó•",code:"A"}, {char:"Êúà",code:"B"}, {char:"Áî∞",code:"W"}] },
            { category: "life", char: "Áé©", code: "MU", first: "M", last: "U", hint: "Áéã(MG)ÂÖÉ(MMKU)Ê∞£", decoys: [{char:"Âúü",code:"G"}, {char:"Èáë",code:"C"}, {char:"ÁÅ´",code:"F"}] },
            { category: "life", char: "Êõ∏", code: "LA", first: "L", last: "A", hint: "ËÅø(LG)Êó•(A)ÁÇ∫Êõ∏", decoys: [{char:"Áï´",code:"LGW"}, {char:"Á≠Ü",code:"HLQ"}, {char:"Áúã",code:"HBU"}] },
            { category: "life", char: "ÂÆ∂", code: "JO", first: "J", last: "O", hint: "ÂÆÄ(J)‰∏ãÊúâË±ï(MSO)", decoys: [{char:"ÂÆâ",code:"JV"}, {char:"ÂÆö",code:"JMO"}, {char:"ÂÆ§",code:"JMIG"}] },
        ];

        const CATEGORIES = [
            { id: 'all', name: 'ÂÖ®ÈÉ®', icon: Star, color: 'bg-purple-100 text-purple-600' },
            { id: 'nature', name: 'Ëá™ÁÑ∂', icon: Leaf, color: 'bg-green-100 text-green-600' },
            { id: 'people', name: '‰∫∫Áâ©', icon: Smile, color: 'bg-amber-100 text-amber-600' },
            { id: 'life', name: 'ÁîüÊ¥ª', icon: Coffee, color: 'bg-blue-100 text-blue-600' },
        ];

        // --- Meta Progression Configuration ---
        const META_UPGRADES = {
            hp: { name: "ÁîüÂëΩ‰πãÊ∫ê", baseCost: 100, costMult: 1.5, effectVal: 10, icon: Heart, desc: "ÂàùÂßã HP +10" },
            atk: { name: "ÂäõÈáèÂñöÈÜí", baseCost: 150, costMult: 1.6, effectVal: 2, icon: Sword, desc: "ÂàùÂßãÊîªÊìä +2" },
            exp: { name: "Êô∫ÊÖßÂÖâÁí∞", baseCost: 200, costMult: 1.8, effectVal: 0.1, icon: BookOpen, desc: "Á∂ìÈ©óÁç≤Âèñ +10%" },
        };

        // üõ°Ô∏è All Artifacts Pool (Some locked by default)
        const RPG_ARTIFACTS = [
            // Basic (Default Unlocked)
            { id: 'wand_1', name: 'Â≠∏ÂæíÊ≥ïÊùñ', type: 'weapon', val: 5, tier: 1, icon: Zap, desc: 'ÊîªÊìäÂäõ +5', unlockCost: 0, effect: (p) => ({ ...p, atk: p.atk + 5 }) },
            { id: 'robe_1', name: 'Â∏ÉË°£', type: 'armor', val: 20, tier: 1, icon: Shield, desc: 'ÊúÄÂ§ß HP +20', unlockCost: 0, effect: (p) => ({ ...p, maxHp: p.maxHp + 20, hp: p.hp + 20 }) },
            { id: 'ring_1', name: 'ÂäõÈáèÊàíÊåá', type: 'accessory', val: 10, tier: 1, icon: Star, desc: 'ÊîªÊìäÂäõ +10', unlockCost: 0, effect: (p) => ({ ...p, atk: p.atk + 10 }) },
            { id: 'boots_1', name: 'ËºïÈùà‰πãÈù¥', type: 'accessory', val: 0.05, tier: 1, icon: Wind, desc: 'ÈñÉÈÅøÁéá +5%', unlockCost: 0, effect: (p) => ({ ...p, dodge: p.dodge + 0.05 }) },
            // Advanced (Need Unlock)
            { id: 'vamp_tooth', name: 'Âê∏Ë°ÄÈ¨º‰πãÁâô', type: 'special', val: 0.1, tier: 2, icon: Droplets, desc: 'Âê∏Ë°Ä +10%', unlockCost: 500, effect: (p) => ({ ...p, lifesteal: p.lifesteal + 0.1 }) },
            { id: 'sharp_stone', name: 'Èõ∑Á•ûÁ£®ÂàÄÁü≥', type: 'special', val: 0.2, tier: 2, icon: Zap, desc: 'Êö¥ÊìäÁéá +20%', unlockCost: 400, effect: (p) => ({ ...p, critChance: p.critChance + 0.2 }) },
            { id: 'spike_shield', name: 'ËçäÊ£òÁõæÁâå', type: 'special', val: 0.2, tier: 2, icon: Shield, desc: 'ÂèçÂÇ∑ +20%', unlockCost: 450, effect: (p) => ({ ...p, thorns: p.thorns + 0.2, maxHp: p.maxHp + 30 }) },
            { id: 'hourglass', name: 'ÊôÇÂÖâÊ≤ôÊºè', type: 'special', val: 1, tier: 2, icon: Timer, desc: 'ÊäÄËÉΩÂÜ∑Âçª -1ÂõûÂêà', unlockCost: 600, effect: (p) => ({ ...p, cdr: p.cdr + 1 }) },
            // Legendary (Need Unlock)
            { id: 'cursed_mask', name: 'Ë©õÂííÈù¢ÂÖ∑', type: 'special', val: 0, tier: 3, icon: Skull, desc: 'ÊîªÊìä +50%, HP -20%', unlockCost: 1000, effect: (p) => ({ ...p, atk: Math.floor(p.atk * 1.5), maxHp: Math.floor(p.maxHp * 0.8), hp: Math.min(p.hp, Math.floor(p.maxHp * 0.8)) }) },
            { id: 'titan_heart', name: 'Ê≥∞Âù¶‰πãÂøÉ', type: 'special', val: 0, tier: 3, icon: Heart, desc: 'ÊúÄÂ§ß HP +100', unlockCost: 800, effect: (p) => ({ ...p, maxHp: p.maxHp + 100, hp: p.hp + 100 }) },
            { id: 'greedy_pot', name: 'Ë≤™Â©™‰πãÂ£∫', type: 'special', val: 0, tier: 3, icon: Coins, desc: 'Áç≤Âæó 100 EXP', unlockCost: 700, effect: (p) => ({ ...p, exp: p.exp + 100 }) },
        ];

        const MONSTER_TYPES = [
            { name: 'Âè≤ËêäÂßÜ', hpMod: 0.8, atkMod: 0.8, speedMod: 0.8, color: 'text-green-400', icon: Ghost },
            { name: 'ËùôËù†', hpMod: 0.6, atkMod: 1.2, speedMod: 1.5, color: 'text-purple-400', icon: Wind },
            { name: 'Áü≥ÂÉèÈ¨º', hpMod: 1.5, atkMod: 1.0, speedMod: 0.6, color: 'text-stone-400', icon: Shield },
            { name: 'ÊöóÂΩ±Âà∫ÂÆ¢', hpMod: 0.8, atkMod: 1.5, speedMod: 1.2, color: 'text-red-400', icon: Sword },
            { name: 'Â≠óÈùàÈæç', hpMod: 2.5, atkMod: 1.5, speedMod: 1.0, color: 'text-yellow-400', icon: Crown, isBoss: true },
            { name: 'Ê∑±Ê∑µÈ†ò‰∏ª', hpMod: 3.0, atkMod: 1.8, speedMod: 0.8, color: 'text-rose-500', icon: Skull, isBoss: true },
        ];

        const RPG_SKILLS = [
            { id: 'heal', name: 'Ê≤ªÁôíË°ì', baseCd: 4, currentCd: 0, icon: Heart, color: 'bg-green-500', effect: (p) => ({ ...p, hp: Math.min(p.maxHp, p.hp + Math.floor(p.maxHp * 0.3)), log: `ÊñΩÊîæÊ≤ªÁôíË°ìÔºÅÂõûÂæ© ${Math.floor(p.maxHp * 0.3)} HP` }) },
            { id: 'burst', name: 'ÁàÜË£ÇÈ≠îÊ≥ï', baseCd: 6, currentCd: 0, icon: Flame, color: 'bg-red-500', effect: (p) => ({ ...p, bonusDmg: p.atk * 2, log: 'ÁàÜË£ÇÈ≠îÊ≥ïËìÑÂäõÔºÅ‰∏ãÊìäÂÇ∑ÂÆ≥ 200%ÔºÅ' }) },
            { id: 'guard', name: 'ÈêµÂ£Å', baseCd: 5, currentCd: 0, icon: Shield, color: 'bg-blue-500', effect: (p) => ({ ...p, shield: 50, log: 'Áç≤Âæó 50 ÈªûË≠∑ÁõæÔºÅ' }) },
        ];

        // --- üèõÔ∏è Meta Shop Component ---
        const MetaShop = ({ metaState, setMetaState, onBack }) => {
            const buyUpgrade = (type) => {
                const cfg = META_UPGRADES[type];
                const currentLv = metaState.upgrades[type];
                const cost = Math.floor(cfg.baseCost * Math.pow(cfg.costMult, currentLv));
                
                if (metaState.coins >= cost) {
                    AudioEngine.coin();
                    setMetaState(prev => ({
                        ...prev,
                        coins: prev.coins - cost,
                        upgrades: { ...prev.upgrades, [type]: currentLv + 1 }
                    }));
                } else {
                    AudioEngine.wrong();
                }
            };

            const unlockArtifact = (artId, cost) => {
                if (metaState.coins >= cost) {
                    AudioEngine.coin();
                    setMetaState(prev => ({
                        ...prev,
                        coins: prev.coins - cost,
                        unlockedArtifacts: [...prev.unlockedArtifacts, artId]
                    }));
                } else {
                    AudioEngine.wrong();
                }
            };

            return (
                <div className="h-full bg-slate-900 text-white p-6 overflow-y-auto">
                    <div className="flex justify-between items-center mb-8 sticky top-0 bg-slate-900/95 p-4 z-10 border-b border-slate-700">
                        <div className="flex items-center gap-4">
                            <button onClick={onBack} className="bg-slate-700 p-2 rounded-full hover:bg-slate-600"><LucideIcon icon={ArrowLeft} /></button>
                            <h2 className="text-2xl font-bold text-magic-300">Áü•Ë≠òËÅñÊÆø</h2>
                        </div>
                        <div className="flex items-center gap-2 bg-slate-800 px-4 py-2 rounded-full border border-gold-500/50">
                            <LucideIcon icon={Coins} className="text-gold-400" />
                            <span className="font-bold text-xl text-gold-400">{metaState.coins}</span>
                        </div>
                    </div>

                    <div className="max-w-5xl mx-auto space-y-12">
                        {/* Upgrades Section */}
                        <section>
                            <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-magic-100"><LucideIcon icon={GraduationCap} /> Âü∫Á§éËÉΩÂäõÂº∑Âåñ</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {Object.entries(META_UPGRADES).map(([key, cfg]) => {
                                    const lv = metaState.upgrades[key];
                                    const cost = Math.floor(cfg.baseCost * Math.pow(cfg.costMult, lv));
                                    const canAfford = metaState.coins >= cost;
                                    
                                    return (
                                        <div key={key} className="bg-slate-800 p-6 rounded-2xl border border-slate-700 relative overflow-hidden">
                                            <div className="flex items-center gap-4 mb-4">
                                                <div className="p-3 bg-magic-900 rounded-lg"><LucideIcon icon={cfg.icon} size={28} className="text-magic-300" /></div>
                                                <div>
                                                    <div className="font-bold text-lg">{cfg.name}</div>
                                                    <div className="text-xs text-slate-400">Lv.{lv}</div>
                                                </div>
                                            </div>
                                            <p className="text-sm text-slate-300 mb-6">{cfg.desc} (Áï∂Ââç: +{Math.round(cfg.effectVal * lv * 10)/10}{key === 'exp' ? '%' : ''})</p>
                                            <button 
                                                onClick={() => buyUpgrade(key)}
                                                disabled={!canAfford}
                                                className={`w-full py-2 rounded-xl font-bold flex items-center justify-center gap-2 ${canAfford ? 'bg-gold-600 hover:bg-gold-500 text-white' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}
                                            >
                                                <span>ÂçáÁ¥ö</span>
                                                <span className="text-xs bg-black/20 px-2 py-0.5 rounded flex items-center"><LucideIcon icon={Coins} size={12} className="mr-1"/>{cost}</span>
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>

                        {/* Artifacts Section */}
                        <section>
                            <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-magic-100"><LucideIcon icon={Lock} /> ÈÅ∫Áâ©Ëß£Èéñ</h3>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                {RPG_ARTIFACTS.filter(a => a.unlockCost > 0).map(art => {
                                    const isUnlocked = metaState.unlockedArtifacts.includes(art.id);
                                    const canAfford = metaState.coins >= art.unlockCost;

                                    return (
                                        <div key={art.id} className={`p-4 rounded-xl border-2 flex flex-col items-center text-center transition-all ${isUnlocked ? 'bg-magic-900/30 border-magic-500/50' : 'bg-slate-800 border-slate-700'}`}>
                                            <div className={`p-3 rounded-full mb-2 ${isUnlocked ? 'bg-magic-500/20' : 'bg-slate-900'}`}>
                                                <LucideIcon icon={art.icon} className={isUnlocked ? 'text-magic-300' : 'text-slate-600'} />
                                            </div>
                                            <h4 className={`font-bold ${isUnlocked ? 'text-white' : 'text-slate-500'}`}>{art.name}</h4>
                                            <p className="text-xs text-slate-400 mb-4 h-8">{art.desc}</p>
                                            
                                            {isUnlocked ? (
                                                <div className="text-green-400 text-xs font-bold flex items-center"><LucideIcon icon={CheckCircle} size={12} className="mr-1"/> Â∑≤Ëß£Èéñ</div>
                                            ) : (
                                                <button 
                                                    onClick={() => unlockArtifact(art.id, art.unlockCost)}
                                                    disabled={!canAfford}
                                                    className={`px-4 py-1 rounded-lg text-xs font-bold flex items-center ${canAfford ? 'bg-gold-600 text-white hover:bg-gold-500' : 'bg-slate-700 text-slate-500'}`}
                                                >
                                                    <LucideIcon icon={Unlock} size={10} className="mr-1"/> {art.unlockCost}
                                                </button>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </section>
                    </div>
                </div>
            );
        };

        // --- ‚öîÔ∏è RPG Game Component ---
        const RPGGame = ({ difficulty, category, onExit, onHome, onLoadGame, initialData, metaState, onGameEnd }) => {
            // Init stats based on Meta Progression
            const baseStats = {
                hp: 100 + (metaState.upgrades.hp * META_UPGRADES.hp.effectVal),
                atk: 20 + (metaState.upgrades.atk * META_UPGRADES.atk.effectVal),
                expMult: 1 + (metaState.upgrades.exp * META_UPGRADES.exp.effectVal)
            };

            const [player, setPlayer] = useState(initialData?.player || {
                hp: baseStats.hp, maxHp: baseStats.hp, atk: baseStats.atk, level: 1, exp: 0, maxExp: 100,
                critChance: 0.1, critMult: 1.5, lifesteal: 0, thorns: 0, dodge: 0, shield: 0, cdr: 0,
                bonusDmg: 0, combo: 0, floor: 1,
                skills: RPG_SKILLS.map(s => ({...s, currentCd: 0})),
                artifacts: [],
                coinsGained: 0
            });
            
            const [monster, setMonster] = useState({ hp: 100, maxHp: 100, name: '‰∫ÇÁ¢ºÊÄ™Áç∏', type: MONSTER_TYPES[0] });
            const [attackGauge, setAttackGauge] = useState(0); 
            const [qIndex, setQIndex] = useState(0);
            const [turn, setTurn] = useState('player'); 
            const [userInput, setUserInput] = useState([]);
            const [combatLog, setCombatLog] = useState("Êà∞È¨•ÈñãÂßãÔºÅ");
            const [animation, setAnimation] = useState(null); 
            const [rewards, setRewards] = useState([]); 
            const [showStats, setShowStats] = useState(false);

            // Filter questions
            const filteredQuestions = useMemo(() => {
                if (category === 'all') return QUESTIONS;
                return QUESTIONS.filter(q => q.category === category);
            }, [category]);
            
            const currentQ = useMemo(() => filteredQuestions[Math.floor(Math.random() * filteredQuestions.length)], [qIndex, category]);

            // Robust Option Generation moved to top level
            const currentOptions = useMemo(() => {
                if (difficulty === 'advanced') return [];

                // Correct Answer
                const correctOption = difficulty === 'beginner' 
                    ? { label: `${KEYBOARD_MAP[currentQ.first]} (${currentQ.first})`, val: currentQ.first, isCorrect: true }
                    : { label: `${KEYBOARD_MAP[currentQ.first]} + ${KEYBOARD_MAP[currentQ.last]}`, val: currentQ.code, isCorrect: true };

                // Generate Decoys
                const safeDecoys = currentQ.decoys.filter(d => 
                    difficulty === 'beginner' 
                    ? d.code[0] !== currentQ.first 
                    : d.code !== currentQ.code
                );

                const decoyOptions = safeDecoys.slice(0, 2).map(d => {
                    if (difficulty === 'beginner') {
                        const firstCode = d.code[0];
                        return { label: `${d.char} (${firstCode})`, val: firstCode, isCorrect: false };
                    } else {
                        const first = d.code[0];
                        const last = d.code[d.code.length - 1];
                        return { label: `${d.char} (${first}+${last})`, val: first+last, isCorrect: false };
                    }
                });

                const allOptions = [correctOption, ...decoyOptions];
                return allOptions.sort(() => Math.random() - 0.5);

            }, [qIndex, difficulty, currentQ]);

            // Init First Monster
            useEffect(() => {
                if (!initialData) spawnMonster();
            }, []);

            const spawnMonster = () => {
                const isBoss = player.floor % 5 === 0;
                const pool = MONSTER_TYPES.filter(m => isBoss ? m.isBoss : !m.isBoss);
                const type = pool[Math.floor(Math.random() * pool.length)];
                
                const scale = 1 + (player.floor * 0.2); // 20% harder per floor
                const hp = Math.floor(100 * type.hpMod * scale);
                const name = `${isBoss ? '„ÄêBOSS„Äë' : ''}${type.name} (F${player.floor})`;
                
                setMonster({ hp, maxHp: hp, name, type });
                setAttackGauge(0);
                setCombatLog(`F${player.floor}: ÈÅ≠ÈÅá ${name}ÔºÅ`);
            };

            // Save Game Function
            const saveGame = () => {
                const saveData = {
                    player,
                    difficulty,
                    date: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(saveData)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `word_battler_save_lv${player.level}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                setCombatLog("ÈÅäÊà≤ÈÄ≤Â∫¶Â∑≤ÂÑ≤Â≠òÔºÅ");
            };

            // Monster Logic
            useEffect(() => {
                let interval;
                if (turn === 'player') {
                    interval = setInterval(() => {
                        setAttackGauge(prev => {
                            if (prev >= 100) {
                                const baseDmg = 10 + (player.floor * 2);
                                const finalDmg = Math.floor(baseDmg * monster.type.atkMod);
                                handlePlayerDamage(finalDmg, `${monster.type.name} ÊîªÊìäÔºÅ`);
                                return 0;
                            }
                            let increment = 2.5 * monster.type.speedMod;
                            if (difficulty === 'intermediate') increment *= 0.7;
                            if (difficulty === 'advanced') increment *= 0.3; 
                            return prev + increment;
                        });
                    }, 200);
                }
                return () => clearInterval(interval);
            }, [turn, difficulty, monster, player.floor]);

            // Handlers
            const handlePlayerDamage = (rawDmg, reason) => {
                if (Math.random() < player.dodge) { setCombatLog(`${reason} MISS!`); return; }
                AudioEngine.hit();
                setAnimation('damage');
                let damage = Math.max(0, rawDmg - player.shield);
                const remainingShield = Math.max(0, player.shield - rawDmg);
                
                if (player.thorns > 0) {
                    const thornsDmg = Math.floor(rawDmg * player.thorns);
                    setMonster(m => ({ ...m, hp: Math.max(0, m.hp - thornsDmg) }));
                }

                setPlayer(p => ({ ...p, hp: Math.max(0, p.hp - damage), shield: remainingShield, combo: 0 }));
                setCombatLog(`${reason} ÂèóÂà∞ ${damage} ÂÇ∑ÂÆ≥ÔºÅ`);
                setTimeout(() => { setAnimation(null); if (player.hp - damage <= 0) handleGameOver(false); }, 300);
            };

            const resolvePlayerAttack = () => {
                const comboMult = 1 + (player.combo * 0.1);
                let damage = (player.atk + player.bonusDmg) * comboMult;
                let isCrit = Math.random() < player.critChance;
                if (isCrit) { damage *= player.critMult; AudioEngine.crit(); } else AudioEngine.attack();
                damage = Math.floor(damage);

                if (player.lifesteal > 0) setPlayer(p => ({ ...p, hp: Math.min(p.maxHp, p.hp + Math.floor(damage * player.lifesteal)) }));

                setPlayer(p => ({ 
                    ...p, bonusDmg: 0, combo: p.combo + 1,
                    skills: p.skills.map(s => ({ ...s, currentCd: Math.max(0, s.currentCd - 1) }))
                })); 
                
                setMonster(m => ({ ...m, hp: Math.max(0, m.hp - damage) }));
                setCombatLog(`${isCrit ? 'ÊúÉÂøÉÔºÅ' : 'ÂëΩ‰∏≠ÔºÅ'} -${damage}`);
                setAttackGauge(prev => Math.max(0, prev - 10));

                if (monster.hp - damage <= 0) setTimeout(handleMonsterDefeat, 600);
                else setTimeout(() => setUserInput([]), 600);
            };

            const handleSkill = (skillId) => {
                if (turn !== 'player') return;
                const idx = player.skills.findIndex(s => s.id === skillId);
                const skill = player.skills[idx];
                if (skill.currentCd > 0) return;

                AudioEngine.skill();
                const updatedSkills = [...player.skills];
                const cooldown = Math.max(1, skill.baseCd - player.cdr);
                updatedSkills[idx] = { ...skill, currentCd: cooldown };

                let newP = { ...player, skills: updatedSkills };
                let log = '';
                if (skill.id === 'heal') { const v = Math.floor(newP.maxHp * 0.3); newP.hp = Math.min(newP.maxHp, newP.hp + v); log = `ÂõûÂæ© ${v} HP`; }
                else if (skill.id === 'burst') { newP.bonusDmg = newP.atk * 2; log = '‰∏ãÊìäÂÇ∑ÂÆ≥ 200%'; }
                else if (skill.id === 'guard') { newP.shield += 50; log = 'Ë≠∑Áõæ +50'; }

                setPlayer(newP);
                setCombatLog(log);
                setAnimation('heal');
                setTimeout(() => setAnimation(null), 800);
            };

            const handleMonsterDefeat = () => {
                AudioEngine.levelUp();
                // EXP & Coin logic
                const expGain = Math.floor((50 + (player.floor * 10)) * baseStats.expMult);
                const coinGain = 10 + Math.floor(player.floor * 2); // Base coin per kill
                
                let newExp = player.exp + expGain;
                let newLevel = player.level;
                let newMaxExp = player.maxExp;
                let leveledUp = false;

                if (newExp >= player.maxExp) {
                    newExp -= player.maxExp;
                    newLevel++;
                    newMaxExp = Math.floor(newMaxExp * 1.2);
                    leveledUp = true;
                }

                setPlayer(p => ({
                    ...p, 
                    exp: newExp, level: newLevel, maxExp: newMaxExp,
                    maxHp: leveledUp ? p.maxHp + 10 : p.maxHp,
                    atk: leveledUp ? p.atk + 2 : p.atk,
                    hp: leveledUp ? p.maxHp : p.hp,
                    floor: p.floor + 1,
                    coinsGained: p.coinsGained + coinGain
                }));

                // Pick Rewards based on Unlocked Pool
                const availableArtifacts = RPG_ARTIFACTS.filter(a => a.unlockCost === 0 || metaState.unlockedArtifacts.includes(a.id));
                const pool = availableArtifacts.sort(() => 0.5 - Math.random()).slice(0, 3);
                setRewards(pool);
                setTurn('reward');
            };

            const handleSelectReward = (reward) => {
                AudioEngine.correct();
                const newP = reward.effect(player);
                const safeArtifact = { id: reward.id, name: reward.name, icon: reward.icon, desc: reward.desc };
                setPlayer({ ...newP, artifacts: [...newP.artifacts, safeArtifact] });

                setQIndex(q => q + 1);
                spawnMonster();
                setUserInput([]);
                setTurn('player');
            };

            const handleGameOver = (isWin) => {
                setTurn(isWin ? 'win' : 'lose');
                AudioEngine.lose();
                // Auto calculate rewards
                const totalCoins = player.coinsGained + (player.floor * 5); // Bonus coins for floor depth
                onGameEnd(totalCoins);
            };

            // Inputs (Same logic as V8, extracted for brevity)
            const handleAttack = (val) => {
                if (turn !== 'player') return;
                const isCorrect = (difficulty==='beginner' && val===currentQ.first) || (difficulty==='intermediate' && val===currentQ.code);
                if (isCorrect) resolvePlayerAttack(); else handlePlayerDamage(5, "Ëº∏ÂÖ•ÈåØË™§ÔºÅ");
            };
            const handleKeyClick = (k) => {
                if (turn !== 'player') return;
                if (userInput.length===0) { if (k===currentQ.first) { AudioEngine.click(); setUserInput([k]); } else { handlePlayerDamage(5, "È¶ñÁ¢ºÈåØË™§"); setUserInput([]); } }
                else if (userInput.length===1) { if (k===currentQ.last) { setUserInput([...userInput, k]); resolvePlayerAttack(); } else { handlePlayerDamage(5, "Â∞æÁ¢ºÈåØË™§"); } }
            };
            
            // Physical KB
            useEffect(() => {
                if (difficulty !== 'advanced') return;
                const h = (e) => { const k = e.key.toUpperCase(); if(/^[A-Z]$/.test(k)) handleKeyClick(k); };
                window.addEventListener('keydown', h); return () => window.removeEventListener('keydown', h);
            }, [difficulty, turn, userInput, currentQ]);

            const renderInput = () => {
                if (difficulty === 'advanced') {
                    const keys = "QWERTYUIOPASDFGHJKLZXCVBNM".split('');
                    return <div className="w-full max-w-3xl mx-auto p-2"><div className="flex justify-center mb-4 space-x-2"><div className={`w-12 h-12 border-2 rounded flex items-center justify-center text-2xl font-bold bg-slate-800 border-magic-500 text-magic-300`}>{userInput[0] && KEYBOARD_MAP[userInput[0]]}</div><div className={`w-12 h-12 border-2 rounded flex items-center justify-center text-2xl font-bold bg-slate-800 border-magic-500 text-magic-300`}>{userInput[1] && KEYBOARD_MAP[userInput[1]]}</div></div><div className="keyboard-grid">{keys.map(k => <button key={k} onClick={() => handleKeyClick(k)} className="aspect-square bg-slate-800 border border-slate-700 rounded flex flex-col items-center justify-center hover:bg-slate-700 active:bg-slate-600"><span className="text-xs text-slate-500">{k}</span><span className="text-magic-300 font-bold">{KEYBOARD_MAP[k]}</span></button>)}</div></div>;
                }
                return <div className="grid grid-cols-3 gap-4 max-w-2xl mx-auto">{currentOptions.map((o,i) => <button key={i} onClick={() => handleAttack(o.val)} className="bg-slate-800 border-2 border-magic-600 py-6 rounded-xl text-xl font-bold text-magic-100 active:scale-95 hover:bg-slate-700">{o.label}</button>)}</div>;
            };

            // --- Screens ---
            if (turn === 'lose') return (
                <div className="absolute inset-0 bg-slate-950 flex flex-col items-center justify-center text-white p-8 z-50">
                    <LucideIcon icon={Skull} size={80} className="text-red-500 mb-6" />
                    <h2 className="text-4xl font-bold mb-2 text-red-500">ÊåëÊà∞ÁµêÊùü</h2>
                    <p className="text-xl mb-4 text-slate-400">Ê≠¢Ê≠•ÊñºÁ¨¨ {player.floor} Â±§</p>
                    <div className="bg-slate-800 p-6 rounded-2xl mb-8 flex flex-col items-center border border-gold-500/30">
                        <p className="text-sm text-gold-400 mb-2">Êú¨Ê¨°Áç≤Âæó</p>
                        <div className="flex items-center gap-2 text-3xl font-bold text-yellow-400">
                            <LucideIcon icon={Coins} /> <span>{player.coinsGained + (player.floor * 5)}</span>
                        </div>
                    </div>
                    <button onClick={() => handleGameOver(false)} className="bg-slate-700 hover:bg-slate-600 px-8 py-3 rounded-full font-bold">ËøîÂõûËÅñÊÆø</button>
                </div>
            );

            if (turn === 'reward') return (
                <div className="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center text-white p-4 z-50">
                    <h2 className="text-3xl font-bold text-yellow-400 mb-8 animate-bounce">Êà∞Âà©ÂìÅÈÅ∏Êìá</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-5xl w-full">
                        {rewards.map((r, i) => (
                            <button key={i} onClick={() => handleSelectReward(r)} className="bg-slate-800 border-2 border-magic-600 hover:scale-105 transition-transform p-6 rounded-2xl flex flex-col items-center shadow-2xl group">
                                <LucideIcon icon={r.icon} size={48} className="text-yellow-400 mb-4 group-hover:scale-110 transition-transform" />
                                <h3 className="text-xl font-bold mb-2">{r.name}</h3>
                                <p className="text-sm text-slate-300">{r.desc}</p>
                            </button>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className={`h-full w-full flex flex-col bg-slate-950 text-white font-sans relative overflow-hidden ${animation === 'damage' ? 'animate-damage-flash' : ''}`}>
                    {/* Header */}
                    <div className="p-3 bg-slate-900/90 border-b border-slate-800 flex justify-between items-center z-10">
                        <div className="flex items-center gap-4 cursor-pointer hover:bg-slate-800/50 rounded-lg p-1 transition-colors" onClick={() => setShowStats(!showStats)}>
                            <div className="w-12 h-12 bg-magic-700 rounded-lg flex flex-col items-center justify-center border-2 border-magic-500">
                                <span className="text-xs">LV</span><span className="font-bold text-xl">{player.level}</span>
                            </div>
                            <div>
                                <div className="text-xs text-slate-400">Floor {player.floor}</div>
                                <div className="w-32 h-3 bg-slate-800 rounded-full overflow-hidden relative"><div className="h-full bg-red-500 transition-all duration-300" style={{width: `${(player.hp/player.maxHp)*100}%`}}></div>{player.shield>0 && <div className="absolute top-0 h-full bg-blue-400/50" style={{width: `${(player.shield/player.maxHp)*100}%`}}/>}</div>
                                <div className="text-[10px] text-right">{player.hp}/{player.maxHp}</div>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-1 text-gold-400 font-bold bg-slate-800 px-3 py-1 rounded-full text-sm border border-slate-700"><LucideIcon icon={Coins} size={14}/> {player.coinsGained}</div>
                            <button onClick={() => handleGameOver(false)} className="p-2 bg-red-900/50 text-red-400 rounded hover:bg-red-900" title="ÊîæÊ£Ñ"><LucideIcon icon={X} size={18}/></button>
                        </div>
                    </div>

                    {/* Stats Overlay */}
                    {showStats && (
                        <div className="absolute top-20 left-4 bg-slate-900/95 border border-slate-700 p-4 rounded-xl z-40 text-sm shadow-xl min-w-[200px]" onClick={()=>setShowStats(false)}>
                            <h4 className="font-bold border-b border-slate-700 mb-2 pb-1 text-magic-300">ËßíËâ≤Â±¨ÊÄß</h4>
                            <p>‚öîÔ∏è ÊîªÊìä: {player.atk}</p>
                            <p>‚ö° Êö¥Êìä: {Math.round(player.critChance*100)}%</p>
                            <p>ü©∏ Âê∏Ë°Ä: {Math.round(player.lifesteal*100)}%</p>
                            <p>üõ°Ô∏è ÂèçÂÇ∑: {Math.round(player.thorns*100)}%</p>
                            <p>üí® ÈñÉÈÅø: {Math.round(player.dodge*100)}%</p>
                            <h4 className="font-bold border-b border-slate-700 mb-2 pb-1 mt-2 text-magic-300">ÈÅ∫Áâ©ËÉåÂåÖ</h4>
                            <div className="flex flex-wrap gap-1">
                                {player.artifacts.map((a,i)=><div key={i} title={a.name} className="bg-slate-800 p-1.5 rounded border border-slate-600 hover:border-gold-500 transition-colors"><LucideIcon icon={a.icon} size={16} className="text-yellow-500"/></div>)}
                            </div>
                        </div>
                    )}

                    {/* Arena */}
                    <div className="flex-1 relative flex flex-col items-center justify-center">
                        <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-magic-900/30 to-slate-950 -z-10"></div>
                        <div className="absolute top-4 flex gap-4 z-20">
                            {player.skills.map(s => (<button key={s.id} onClick={() => handleSkill(s.id)} disabled={s.currentCd > 0} className={`w-14 h-14 rounded-full border-2 flex items-center justify-center relative transition-transform active:scale-95 ${s.currentCd > 0 ? 'bg-slate-800 border-slate-600 opacity-50 cursor-not-allowed' : `${s.color} border-white shadow-lg`}`}><LucideIcon icon={s.icon} size={24} className="text-white" />{s.currentCd > 0 && <div className="absolute inset-0 bg-black/60 rounded-full flex items-center justify-center font-bold text-white">{s.currentCd}</div>}</button>))}
                        </div>
                        <motion.div animate={{ y: [0, -10, 0] }} transition={{ repeat: Infinity, duration: 3 }} className="relative z-10 mt-8 mb-4">
                            <div className="w-40 h-40 bg-slate-800 rounded-full border-4 border-magic-500 flex items-center justify-center shadow-[0_0_30px_rgba(139,92,246,0.4)]">
                                <LucideIcon icon={monster.type.icon} size={80} className={monster.type.color} />
                                <span className="absolute text-7xl font-serif font-black text-white drop-shadow-md">{currentQ.char}</span>
                            </div>
                            <div className="absolute -bottom-6 left-1/2 transform -translate-x-1/2 w-32 h-2 bg-slate-800 rounded-full overflow-hidden border border-slate-600">
                                <motion.div className="h-full bg-red-500" style={{ width: `${attackGauge}%` }} transition={{ ease: 'linear', duration: 0.2 }} />
                            </div>
                            <div className="absolute -top-8 w-full text-center text-red-400 font-bold text-sm">{monster.name}</div>
                        </motion.div>
                        <div className="text-center h-8 font-bold text-lg text-magic-200">{combatLog}</div>
                    </div>

                    <div className="bg-slate-900 border-t border-slate-800 p-6 rounded-t-3xl shadow-2xl">
                        <div className="max-w-4xl mx-auto text-center">{renderInput()}</div>
                    </div>
                </div>
            );
        };

        // --- üè† App Component ---
        const App = () => {
            const [view, setView] = useState('home'); 
            const [userName, setUserName] = useState('');
            const [saveData, setSaveData] = useState(null);
            const [config, setConfig] = useState({ difficulty: 'beginner', category: 'all' });
            
            // Meta Progression State
            const [metaState, setMetaState] = useState({
                coins: 0,
                upgrades: { hp: 0, atk: 0, exp: 0 },
                unlockedArtifacts: ['wand_1', 'robe_1', 'ring_1', 'boots_1']
            });

            // Load Meta State & Name on Init
            useEffect(() => {
                const saved = localStorage.getItem('speedy_adventure_meta');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        setMetaState(parsed.metaState || metaState);
                        setUserName(parsed.userName || '');
                    } catch(e) {}
                }
            }, []);

            // Save Meta State Automatically
            useEffect(() => {
                localStorage.setItem('speedy_adventure_meta', JSON.stringify({ metaState, userName }));
            }, [metaState, userName]);

            const goHome = () => setView('home');

            const handleGameEnd = (coinsEarned) => {
                setMetaState(prev => ({ ...prev, coins: prev.coins + coinsEarned }));
                setView('mode_select');
            };

            const handleExportSave = () => {
                const data = JSON.stringify({ metaState, userName, date: new Date().toISOString() });
                const blob = new Blob([data], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `word_battler_backup.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleImportSave = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.metaState) setMetaState(data.metaState);
                        if (data.userName) setUserName(data.userName);
                        alert("Â≠òÊ™îËÆÄÂèñÊàêÂäüÔºÅ");
                    } catch (err) { alert("ÁÑ°ÊïàÁöÑÂ≠òÊ™îÔºÅ"); }
                };
                reader.readAsText(file);
            };

            if (view === 'home') return (
                <div className="h-full flex flex-col items-center justify-center bg-slate-900 p-6 text-white">
                    <div className="bg-slate-800 p-8 rounded-3xl shadow-2xl text-center w-full max-w-md border border-slate-700">
                        <LucideIcon icon={Rocket} size={64} className="text-magic-500 mx-auto mb-6" />
                        <h1 className="text-4xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-magic-300 to-brand-300">ÈÄüÊàêÂ§ßÂÜíÈö™ V9</h1>
                        <p className="text-slate-400 mb-8">Roguelite Áü•Ë≠òÊ∑±Ê∑µ</p>
                        
                        <input className="w-full p-4 bg-slate-900 border border-slate-600 rounded-xl text-center text-lg mb-6 text-white focus:border-magic-500 outline-none" placeholder="Âè¨ÂñöÂ∏´‰πãÂêç" value={userName} onChange={e=>setUserName(e.target.value)} />
                        
                        <button disabled={!userName} onClick={()=>{AudioEngine.click(); setView('mode_select')}} className="w-full bg-magic-600 hover:bg-magic-500 text-white p-4 rounded-xl font-bold shadow-lg disabled:opacity-50 transition-all flex items-center justify-center gap-2 mb-4">
                            <LucideIcon icon={Play} /> ÈÄ≤ÂÖ•Ê∑±Ê∑µ
                        </button>

                        <div className="flex gap-4 justify-center text-sm text-slate-500">
                            <label className="cursor-pointer hover:text-magic-300 flex items-center gap-1"><LucideIcon icon={Upload} size={14}/> ËÆÄÂèñ <input type="file" className="hidden" onChange={handleImportSave}/></label>
                            <button onClick={handleExportSave} className="hover:text-magic-300 flex items-center gap-1"><LucideIcon icon={Download} size={14}/> ÂÇô‰ªΩ</button>
                        </div>
                    </div>
                </div>
            );

            if (view === 'mode_select') return (
                <div className="h-full bg-slate-950 p-6 overflow-y-auto text-white">
                    <div className="flex justify-between items-center mb-8 max-w-4xl mx-auto">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 bg-magic-900 rounded-full flex items-center justify-center border border-magic-600"><LucideIcon icon={User} className="text-magic-300"/></div>
                            <div><h2 className="text-xl font-bold">{userName}</h2><div className="flex items-center gap-1 text-gold-400 text-sm"><LucideIcon icon={Coins} size={14}/> {metaState.coins}</div></div>
                        </div>
                        <button onClick={()=>setView('home')} className="p-2 bg-slate-800 rounded-full hover:bg-slate-700"><LucideIcon icon={Home} /></button>
                    </div>

                    <div className="grid gap-6 max-w-4xl mx-auto">
                        {/* Shop Banner */}
                        <div onClick={()=>setView('meta_shop')} className="bg-gradient-to-r from-slate-900 to-magic-900 p-6 rounded-3xl border border-magic-500/30 cursor-pointer hover:scale-[1.02] transition-transform flex items-center justify-between">
                            <div><h3 className="text-2xl font-bold text-gold-400 mb-1 flex items-center gap-2"><LucideIcon icon={ShoppingBag}/> Áü•Ë≠òËÅñÊÆø</h3><p className="text-slate-400 text-sm">Ê∂àËÄóÁü•Ë≠òÂπ£ÔºåÂº∑ÂåñËá™Ë∫´ËàáËß£ÈéñÈÅ∫Áâ©</p></div>
                            <LucideIcon icon={ArrowLeft} className="rotate-180 text-slate-500" />
                        </div>

                        {/* Game Modes */}
                        <div className="grid md:grid-cols-2 gap-6">
                            <div className="bg-slate-800 p-6 rounded-3xl border border-slate-700 hover:border-magic-500 transition-colors">
                                <LucideIcon icon={Sword} size={40} className="text-purple-400 mb-4" />
                                <h3 className="text-2xl font-bold mb-2">Ê∑±Ê∑µË©¶ÁÖâ (RPG)</h3>
                                <p className="text-slate-400 text-sm mb-6">ÊåëÊà∞ÁÑ°ÈôêÂ±§Êï∏ÔºåRoguelite ÊàêÈï∑È´îÈ©ó„ÄÇ</p>
                                <div className="space-y-2">
                                    {['beginner', 'intermediate', 'advanced'].map(d => (
                                        <button key={d} onClick={()=>{setConfig({...config, difficulty:d}); setView('category_select')}} className="w-full p-3 bg-slate-900 rounded-xl text-left border border-slate-700 hover:bg-magic-900/50 hover:border-magic-500 transition-colors flex justify-between items-center group">
                                            <span className="group-hover:text-magic-300">{d==='beginner'?'üü¢ Â≠∏Âæí':d==='intermediate'?'üü° Ê≥ïÂ∏´':'üî¥ Ë≥¢ËÄÖ'}</span>
                                            <LucideIcon icon={Play} size={16} className="opacity-0 group-hover:opacity-100 transition-opacity"/>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-slate-800 p-6 rounded-3xl border border-slate-700 opacity-50 cursor-not-allowed">
                                <LucideIcon icon={Zap} size={40} className="text-slate-500 mb-4" />
                                <h3 className="text-2xl font-bold mb-2 text-slate-500">ÈÄüÊàêË∑ëÈÖ∑</h3>
                                <p className="text-slate-600 text-sm">Ê®°ÂºèÁ∂≠Ë≠∑‰∏≠...</p>
                            </div>
                        </div>
                    </div>
                </div>
            );

            if (view === 'meta_shop') return <MetaShop metaState={metaState} setMetaState={setMetaState} onBack={()=>setView('mode_select')} />;

            if (view === 'category_select') return (
                <div className="h-full bg-slate-950 p-6 text-white">
                    <div className="flex justify-between items-center mb-8 max-w-2xl mx-auto"><h2 className="text-2xl font-bold">ÈÅ∏ÊìáÊåëÊà∞ÁØÑÁñá</h2><button onClick={()=>setView('mode_select')} className="p-2 bg-slate-800 rounded-full"><LucideIcon icon={ArrowLeft} /></button></div>
                    <div className="grid grid-cols-2 gap-4 max-w-2xl mx-auto">
                        {CATEGORIES.map(cat => (
                            <button key={cat.id} onClick={()=>{setConfig({...config, category:cat.id}); setView('game_rpg')}} className="p-6 bg-slate-800 rounded-2xl border border-slate-700 hover:border-magic-500 hover:bg-slate-700 transition-all flex flex-col items-center gap-3">
                                <div className={`p-3 rounded-full bg-slate-900 ${cat.color.replace('bg-', 'text-').replace('100', '400')}`}><LucideIcon icon={cat.icon} size={32} /></div>
                                <span className="font-bold">{cat.name}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );

            if (view === 'game_rpg') return <RPGGame user={userName} difficulty={config.difficulty} category={config.category} metaState={metaState} onGameEnd={handleGameEnd} onExit={()=>setView('mode_select')} onHome={goHome} />;
            if (view === 'game_rpg_load') return <RPGGame user={userName} difficulty={config.difficulty} category={config.category} metaState={metaState} onGameEnd={handleGameEnd} onExit={()=>setView('mode_select')} onHome={goHome} initialData={saveData} />;

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
