<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÈÄüÊàêÂ§ßÂÜíÈö™ | Quick Input Adventure V12</title>
    
    <!-- Core Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand': { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7' },
                        'magic': { 950: '#1e1b4b', 900: '#2e1065', 800: '#4c1d95', 600: '#7c3aed', 500: '#8b5cf6', 300: '#c4b5fd', 100: '#ede9fe' },
                        'gold': { 400: '#facc15', 500: '#eab308', 600: '#ca8a04' },
                        'danger': { 900: '#450a0a', 500: '#ef4444' }
                    },
                    fontFamily: {
                        'serif': ['"Noto Serif TC"', '"Songti TC"', 'serif'],
                        'sans': ['"Noto Sans TC"', 'sans-serif'],
                        'mono': ['"Noto Sans Mono"', 'monospace'],
                    },
                    animation: {
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'damage-flash': 'damageFlash 0.3s ease-in-out',
                        'float-up': 'floatUp 1s ease-out forwards',
                        'coin-spin': 'coinSpin 1s linear infinite',
                    },
                    keyframes: {
                        shake: { '10%, 90%': { transform: 'translate3d(-2px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(4px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-6px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(6px, 0, 0)' } },
                        pulseGlow: { '0%, 100%': { opacity: 1, filter: 'brightness(1)' }, '50%': { opacity: 0.8, filter: 'brightness(1.3)' } },
                        damageFlash: { '0%, 100%': { backgroundColor: 'transparent' }, '50%': { backgroundColor: 'rgba(239, 68, 68, 0.3)' } },
                        floatUp: { '0%': { transform: 'translateY(0) scale(1)', opacity: 1 }, '100%': { transform: 'translateY(-50px) scale(1.5)', opacity: 0 } },
                        coinSpin: { '0%': { transform: 'rotateY(0deg)' }, '100%': { transform: 'rotateY(360deg)' } }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Noto+Serif+TC:wght@700&display=swap');
        html, body, #root { height: 100%; margin: 0; padding: 0; font-family: 'Noto Sans TC', sans-serif; overflow: hidden; touch-action: manipulation; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .keyboard-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { motion, AnimatePresence } = window.Motion;
        const { icons } = lucide;
        const { 
            Settings, Volume2, ArrowLeft, Play, User, Trophy, Star, Zap, LayoutGrid, Rocket, Heart, AlertTriangle, 
            CheckCircle, RefreshCw, Keyboard, MousePointer2, Box, Home, Trees, Cloud, Moon, Flag, Timer, Leaf, 
            Smile, Coffee, BookOpen, Sword, Shield, Ghost, Sparkles, Skull, Flame, Plus, Crown, Gift, Hammer, 
            Droplets, Wind, Eye, Save, Upload, Download, X, Coins, GraduationCap, Lock, Unlock, ShoppingBag, 
            Tent, BedDouble, Dumbbell, Gem
        } = icons;

        const LucideIcon = ({ icon, size = 24, className = "" }) => icon ? <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icon.map(([tag, attrs], i) => React.createElement(tag, { ...attrs, key: i }))}</svg> : null;

        // --- üéµ Audio Engine ---
        const AudioEngine = {
            ctx: null,
            init: function() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            playTone: function(freq, type, duration, vol = 0.1) {
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            },
            correct: function() { this.playTone(880, 'sine', 0.1); setTimeout(() => this.playTone(1760, 'sine', 0.2), 100); },
            wrong: function() { this.playTone(150, 'sawtooth', 0.3); setTimeout(() => this.playTone(100, 'sawtooth', 0.4), 150); },
            click: function() { this.playTone(400, 'triangle', 0.05, 0.05); },
            attack: function() { this.playTone(100, 'square', 0.1, 0.3); setTimeout(() => this.playTone(50, 'sawtooth', 0.2, 0.3), 50); }, 
            crit: function() { this.playTone(600, 'square', 0.1, 0.4); setTimeout(() => this.playTone(1200, 'square', 0.2, 0.4), 100); }, 
            hit: function() { this.playTone(80, 'sawtooth', 0.2, 0.3); },
            skill: function() { [300, 400, 500].forEach((f, i) => setTimeout(() => this.playTone(f, 'sine', 0.2), i * 50)); },
            levelUp: function() { [440, 554, 659, 880, 1108].forEach((f, i) => setTimeout(() => this.playTone(f, 'triangle', 0.3), i * 100)); },
            win: function() { [523, 659, 784, 1046].forEach((f, i) => setTimeout(() => this.playTone(f, 'square', 0.2), i * 150)); },
            lose: function() { [300, 250, 200].forEach((f, i) => setTimeout(() => this.playTone(f, 'sawtooth', 0.3), i * 300)); },
            coin: function() { this.playTone(1200, 'sine', 0.1, 0.1); setTimeout(() => this.playTone(1600, 'sine', 0.2, 0.1), 50); },
            heal: function() { this.playTone(400, 'sine', 0.5, 0.2); setTimeout(() => this.playTone(600, 'sine', 0.5, 0.2), 200); },
            block: function() { this.playTone(100, 'square', 0.1, 0.3); }
        };

        // --- üìö Data & Utils ---
        const KEYBOARD_MAP = { 'A': 'Êó•', 'B': 'Êúà', 'C': 'Èáë', 'D': 'Êú®', 'E': 'Ê∞¥', 'F': 'ÁÅ´', 'G': 'Âúü', 'H': 'Á´π', 'I': 'Êàà', 'J': 'ÂçÅ', 'K': 'Â§ß', 'L': '‰∏≠', 'M': '‰∏Ä', 'N': 'Âºì', 'O': '‰∫∫', 'P': 'ÂøÉ', 'Q': 'Êâã', 'R': 'Âè£', 'S': 'Â∞∏', 'T': 'Âªø', 'U': 'Â±±', 'V': 'Â•≥', 'W': 'Áî∞', 'X': 'Èõ£', 'Y': 'Âçú', 'Z': 'Èáç' };
        
        // üìö Chapters Definition
        const CHAPTERS = [
            { id: '01', code: 'A', name: 'Êó•' }, { id: '02', code: 'B', name: 'Êúà' }, { id: '03', code: 'C', name: 'Èáë' }, { id: '04', code: 'D', name: 'Êú®' },
            { id: '05', code: 'E', name: 'Ê∞¥' }, { id: '06', code: 'F', name: 'ÁÅ´' }, { id: '07', code: 'G', name: 'Âúü' }, { id: '08', code: 'H', name: 'Á´π' },
            { id: '09', code: 'I', name: 'Êàà' }, { id: '10', code: 'J', name: 'ÂçÅ' }, { id: '11', code: 'K', name: 'Â§ß' }, { id: '12', code: 'L', name: '‰∏≠' },
            { id: '13', code: 'M', name: '‰∏Ä' }, { id: '14', code: 'N', name: 'Âºì' }, { id: '15', code: 'O', name: '‰∫∫' }, { id: '16', code: 'P', name: 'ÂøÉ' },
            { id: '17', code: 'Q', name: 'Êâã' }, { id: '18', code: 'R', name: 'Âè£' }, { id: '19', code: 'S', name: 'Â∞∏' }, { id: '20', code: 'T', name: 'Âªø' },
            { id: '21', code: 'U', name: 'Â±±' }, { id: '22', code: 'V', name: 'Â•≥' }, { id: '23', code: 'W', name: 'Áî∞' }, { id: '24', code: 'Y', name: 'Âçú' },
            { id: '25', code: 'X', name: 'Èõ£' }
        ];

        // üìö Comprehensive Question Bank (01-25)
        const QUESTIONS = [
            // 01 - Êó• (A)
            { mainCode: 'A', char: "Êó•", code: "A", first: "A", last: "A", hint: "Â§™ÈôΩ", decoys: [{char:"Êúà",code:"B"},{char:"Âè£",code:"R"}] },
            { mainCode: 'A', char: "Êòé", code: "AB", first: "A", last: "B", hint: "Êó•ÊúàÁÇ∫Êòé", decoys: [{char:"Êú®",code:"D"},{char:"ÁõÆ",code:"BU"}] },
            { mainCode: 'A', char: "Êó©", code: "AJ", first: "A", last: "J", hint: "Â§™ÈôΩÂçÅÈªû", decoys: [{char:"Êó±",code:"AMJ"},{char:"Êòá",code:"AHT"}] },
            { mainCode: 'A', char: "Êò®", code: "AOS", first: "A", last: "S", hint: "Êó•+‰πç", decoys: [{char:"ÊôÇ",code:"AGDI"},{char:"Êöó",code:"AYTA"}] },
            
            // 02 - Êúà (B)
            { mainCode: 'B', char: "Êúà", code: "B", first: "B", last: "B", hint: "Êúà‰∫Æ", decoys: [{char:"Êó•",code:"A"},{char:"ÁõÆ",code:"BU"}] },
            { mainCode: 'B', char: "Êúã", code: "BB", first: "B", last: "B", hint: "ÂÖ©ÂÄãÊúà", decoys: [{char:"Êòé",code:"AB"},{char:"ËÇù",code:"BMJ"}] },
            { mainCode: 'B', char: "Êúç", code: "BSE", first: "B", last: "E", hint: "Êúà+Âç©+Âèà", decoys: [{char:"ËÇ¢",code:"BJE"},{char:"ËÇ•",code:"BAU"}] },

            // 03 - Èáë (C)
            { mainCode: 'C', char: "Èáë", code: "C", first: "C", last: "C", hint: "ÈáëÂ±¨", decoys: [{char:"ÂÖ®",code:"OMG"},{char:"ÂÖ¨",code:"CI"}] },
            { mainCode: 'C', char: "ÈäÄ", code: "CAV", first: "C", last: "V", hint: "Èáë+ËâÆ", decoys: [{char:"ÈäÖ",code:"CBMR"},{char:"Èêµ",code:"CJIG"}] },
            { mainCode: 'C', char: "ÈåØ", code: "CTA", first: "C", last: "A", hint: "Èáë+Êòî", decoys: [{char:"Èå®",code:"CTW"},{char:"Èáù",code:"CJ"}] },

            // 04 - Êú® (D)
            { mainCode: 'D', char: "Êûó", code: "DD", first: "D", last: "D", hint: "ÈõôÊú®", decoys: [{char:"Ê£Æ",code:"DDD"},{char:"Ê®π",code:"DGDI"}] },
            { mainCode: 'D', char: "Ê®π", code: "DGDI", first: "D", last: "I", hint: "Êú®+Âªö", decoys: [{char:"Êùë",code:"DDI"},{char:"Êùê",code:"DH"}] },
            { mainCode: 'D', char: "Ê†°", code: "DYK", first: "D", last: "K", hint: "Êú®+‰∫§", decoys: [{char:"Ê†º",code:"DHER"},{char:"Êùø",code:"DHE"}] },

            // 05 - Ê∞¥ (E)
            { mainCode: 'E', char: "Ê∞¥", code: "E", first: "E", last: "E", hint: "ÊµÅÊ∞¥", decoys: [{char:"ÂÜ∞",code:"IM"},{char:"Ê±Ç",code:"IJE"}] },
            { mainCode: 'E', char: "Ê±ü", code: "EM", first: "E", last: "M", hint: "Ê∞¥+Â∑•", decoys: [{char:"Ê≤≥",code:"EMR"},{char:"Êµ∑",code:"EOWY"}] },
            { mainCode: 'E', char: "Êµ∑", code: "EOWY", first: "E", last: "Y", hint: "Ê∞¥+ÊØè", decoys: [{char:"Ê¥ã",code:"ETQ"},{char:"Ê∑±",code:"EBCD"}] },

            // 06 - ÁÅ´ (F)
            { mainCode: 'F', char: "ÁÅ´", code: "F", first: "F", last: "F", hint: "ÁÅ´ÁÑ∞", decoys: [{char:"ÁÇé",code:"FF"},{char:"ÁÅ∞",code:"KF"}] },
            { mainCode: 'F', char: "Ááà", code: "FNOT", first: "F", last: "T", hint: "ÁÅ´+Áôª", decoys: [{char:"Ááí",code:"FJPU"},{char:"ÁáÉ",code:"FBKF"}] },

            // 07 - Âúü (G)
            { mainCode: 'G', char: "Âúü", code: "G", first: "G", last: "G", hint: "ÂúüÂú∞", decoys: [{char:"Â£´",code:"JM"},{char:"Â∑•",code:"M"}] },
            { mainCode: 'G', char: "Âú∞", code: "GPD", first: "G", last: "D", hint: "Âúü+‰πü", decoys: [{char:"ÂùÄ",code:"GYLM"},{char:"Â†¥",code:"GASH"}] },
            
            // 08 - Á´π (H)
            { mainCode: 'H', char: "Á≠Ü", code: "HLQ", first: "H", last: "Q", hint: "Á´π+ËÅø", decoys: [{char:"Á¨ë",code:"HHK"},{char:"Á≠â",code:"HGDI"}] },
            { mainCode: 'H', char: "Á¨ë", code: "HHK", first: "H", last: "K", hint: "Á´π+Â§≠", decoys: [{char:"Á≠î",code:"HOMR"},{char:"ÁÆ°",code:"HJRR"}] },

            // 09 - Êàà (I)
            { mainCode: 'I', char: "Êàë", code: "HQI", first: "H", last: "I", hint: "Êâã+Êàà", decoys: [{char:"Êâæ",code:"QHI"},{char:"Êàê",code:"IHS"}] },
            { mainCode: 'I', char: "Êàê", code: "IHS", first: "I", last: "S", hint: "ÊàêÂäü", decoys: [{char:"Âí∏",code:"IHR"},{char:"ÊÑü",code:"IHP"}] },

            // 10 - ÂçÅ (J)
            { mainCode: 'J', char: "Ëªä", code: "JWJ", first: "J", last: "J", hint: "ÂçÅÁî∞ÂçÅ", decoys: [{char:"Êù±",code:"DW"},{char:"Áî≥",code:"LWL"}] },
            { mainCode: 'J', char: "Âçó", code: "JBJ", first: "J", last: "J", hint: "ÂçÅÊúàÂçÅ", decoys: [{char:"Âçî",code:"KSSS"},{char:"Âçö",code:"IBI"}] },

            // 11 - Â§ß (K)
            { mainCode: 'K', char: "Â§©", code: "MK", first: "M", last: "K", hint: "‰∏ÄÂ§ß", decoys: [{char:"Â§´",code:"QO"},{char:"Â§™",code:"KI"}] },
            { mainCode: 'K', char: "Áæé", code: "TGK", first: "T", last: "K", hint: "ÁæäÂ§ß", decoys: [{char:"ÂñÑ",code:"TGR"},{char:"Áæ©",code:"TGI"}] },

            // 12 - ‰∏≠ (L)
            { mainCode: 'L', char: "‰∏≠", code: "L", first: "L", last: "L", hint: "‰∏≠ÂøÉ", decoys: [{char:"Ëô´",code:"LMI"},{char:"Âø†",code:"LP"}] },
            { mainCode: 'L', char: "Âè≤", code: "JL", first: "J", last: "L", hint: "‰∏≠+‰πÇ", decoys: [{char:"Âêè",code:"JLK"},{char:"‰∫ã",code:"JLLN"}] },

            // 13 - ‰∏Ä (M)
            { mainCode: 'M', char: "Èõ®", code: "MLBY", first: "M", last: "Y", hint: "Â§©‰∏ä‰∏ãÈõ®", decoys: [{char:"Èõ™",code:"MBMS"},{char:"Èõ∑",code:"MBMW"}] },
            { mainCode: 'M', char: "‰∏ç", code: "MF", first: "M", last: "F", hint: "‰∏ÄÁÅ´", decoys: [{char:"Âê¶",code:"MFR"},{char:"ÊùØ",code:"DMF"}] },

            // 14 - Âºì (N)
            { mainCode: 'N', char: "Âºì", code: "N", first: "N", last: "N", hint: "ÂºìÁÆ≠", decoys: [{char:"Âºï",code:"NL"},{char:"Âºü",code:"CNH"}] },
            { mainCode: 'N', char: "È£õ", code: "NOHTO", first: "N", last: "O", hint: "È£õË°å", decoys: [{char:"È¢®",code:"HNI"},{char:"Ê∞£",code:"ONMF"}] },

            // 15 - ‰∫∫ (O)
            { mainCode: 'O', char: "‰∫∫", code: "O", first: "O", last: "O", hint: "‰∫∫È°û", decoys: [{char:"ÂÖ•",code:"OH"},{char:"Â§ß",code:"K"}] },
            { mainCode: 'O', char: "ÂÅö", code: "OJRK", first: "O", last: "K", hint: "‰∫∫+ÊïÖ", decoys: [{char:"‰Ωú",code:"OOS"},{char:"‰ø°",code:"OYMR"}] },
            
            // 16 - ÂøÉ (P)
            { mainCode: 'P', char: "ÂøÉ", code: "P", first: "P", last: "P", hint: "ÂøÉËáü", decoys: [{char:"ÂøÖ",code:"PH"},{char:"ÊÄù",code:"WP"}] },
            { mainCode: 'P', char: "ÊÉ≥", code: "DUP", first: "D", last: "P", hint: "Êú®ÁõÆÂøÉ", decoys: [{char:"ÊÄù",code:"WP"},{char:"ÊÑè",code:"YTP"}] },

            // 17 - Êâã (Q)
            { mainCode: 'Q', char: "Êâã", code: "Q", first: "Q", last: "Q", hint: "ÈõôÊâã", decoys: [{char:"ÊØõ",code:"HQU"},{char:"Áúã",code:"HQBU"}] },
            { mainCode: 'Q', char: "Êâì", code: "QMN", first: "Q", last: "N", hint: "Êâã+‰∏Å", decoys: [{char:"Êâæ",code:"QHI"},{char:"Êãç",code:"QHA"}] },

            // 18 - Âè£ (R)
            { mainCode: 'R', char: "Âè£", code: "R", first: "R", last: "R", hint: "Âè£ÈÉ®", decoys: [{char:"Âõû",code:"WR"},{char:"Áî∞",code:"W"}] },
            { mainCode: 'R', char: "ÂêÉ", code: "RON", first: "R", last: "N", hint: "Âè£+‰πû", decoys: [{char:"Âñù",code:"RAPV"},{char:"Âè´",code:"RVH"}] },

            // 19 - Â∞∏ (S)
            { mainCode: 'S', char: "Â∞∫", code: "SO", first: "S", last: "O", hint: "Â∞∏+‰∫∫", decoys: [{char:"Â±Ä",code:"SSR"},{char:"Â±ã",code:"SMIG"}] },
            { mainCode: 'S', char: "Â±§", code: "SCWA", first: "S", last: "A", hint: "Â∞∏+Êõæ", decoys: [{char:"Â±Ö",code:"SJR"},{char:"Â±ï",code:"STV"}] },

            // 20 - Âªø (T)
            { mainCode: 'T', char: "Ëä±", code: "TOP", first: "T", last: "P", hint: "Ëçâ+Âåñ", decoys: [{char:"Ëçâ",code:"TAJ"},{char:"Ëãó",code:"TW"}] },
            { mainCode: 'T', char: "ÈªÉ", code: "TWC", first: "T", last: "C", hint: "Âªø‰∏ÄÈáë", decoys: [{char:"ÂÖ±",code:"TC"},{char:"Êòî",code:"TA"}] },

            // 21 - Â±± (U)
            { mainCode: 'U', char: "Â±±", code: "U", first: "U", last: "U", hint: "È´òÂ±±", decoys: [{char:"Âá∫",code:"UU"},{char:"Â≤©",code:"UMR"}] },
            { mainCode: 'U', char: "ÂæÆ", code: "HOUK", first: "H", last: "K", hint: "Â±±Âú®‰∏≠Èñì", decoys: [{char:"Âæµ",code:"HOKK"},{char:"ÂæΩ",code:"HFBK"}] },

            // 22 - Â•≥ (V)
            { mainCode: 'V', char: "Â•≥", code: "V", first: "V", last: "V", hint: "Â•≥ÊÄß", decoys: [{char:"Â™Ω",code:"VSQF"},{char:"Âßê",code:"VBM"}] },
            { mainCode: 'V', char: "Â•Ω", code: "VND", first: "V", last: "D", hint: "Â•≥+Â≠ê", decoys: [{char:"Â¶Ç",code:"VR"},{char:"Â¶ô",code:"VHIT"}] },

            // 23 - Áî∞ (W)
            { mainCode: 'W', char: "Áî∞", code: "W", first: "W", last: "W", hint: "Áî∞Âú∞", decoys: [{char:"Áî±",code:"LW"},{char:"Áî≤",code:"WL"}] },
            { mainCode: 'W', char: "Áî∑", code: "WKS", first: "W", last: "S", hint: "Áî∞+Âäõ", decoys: [{char:"Êûú",code:"WD"},{char:"Á¥Ø",code:"WVF"}] },

            // 24 - Âçú (Y)
            { mainCode: 'Y', char: "Âçú", code: "Y", first: "Y", last: "Y", hint: "Âç†Âçú", decoys: [{char:"‰∏ä",code:"YM"},{char:"‰∏ã",code:"MY"}] },
            { mainCode: 'Y', char: "Èªû", code: "WFIR", first: "W", last: "F", hint: "Èªë+Âç†(OYR)", decoys: [{char:"Â∫ó",code:"IYR"},{char:"Á´ô",code:"XYR"}] },

            // 25 - Èõ£ (X)
            { mainCode: 'X', char: "Èõ£", code: "XOG", first: "X", last: "G", hint: "Èõ£Â≠óÈÉ®", decoys: [{char:"ÈΩä",code:"YX"},{char:"ÈΩã",code:"YXF"}] },
            { mainCode: 'X', char: "ÈΩä", code: "YX", first: "Y", last: "X", hint: "Âçú+Èõ£", decoys: [{char:"Âäë",code:"YXLN"},{char:"Êøü",code:"EYX"}] },
        ];

        const THEMES = {
            FOREST: { id: 'forest', name: 'Ê£ÆÊûó', bg: 'bg-green-100', road: 'from-green-800 to-green-600', decor: Trees },
            SPACE: { id: 'space', name: 'Â§™Á©∫', bg: 'bg-slate-900', road: 'from-blue-900 to-slate-800', decor: Moon },
            ANCIENT: { id: 'ancient', name: 'Âè§È¢®', bg: 'bg-amber-50', road: 'from-amber-800 to-amber-600', decor: Cloud }
        };

        const CATEGORIES = [
            { id: 'all', name: 'ÂÖ®ÈÉ®', icon: Star, color: 'bg-purple-100 text-purple-600' },
            { id: 'nature', name: 'Ëá™ÁÑ∂', icon: Leaf, color: 'bg-green-100 text-green-600' },
            { id: 'people', name: '‰∫∫Áâ©', icon: Smile, color: 'bg-amber-100 text-amber-600' },
            { id: 'life', name: 'ÁîüÊ¥ª', icon: Coffee, color: 'bg-blue-100 text-blue-600' },
        ];

        const META_UPGRADES = {
            hp: { name: "ÁîüÂëΩ‰πãÊ∫ê", baseCost: 100, costMult: 1.5, effectVal: 10, icon: Heart, desc: "ÂàùÂßã HP +10" },
            atk: { name: "ÂäõÈáèÂñöÈÜí", baseCost: 150, costMult: 1.6, effectVal: 2, icon: Sword, desc: "ÂàùÂßãÊîªÊìä +2" },
            exp: { name: "Êô∫ÊÖßÂÖâÁí∞", baseCost: 200, costMult: 1.8, effectVal: 0.1, icon: BookOpen, desc: "Á∂ìÈ©óÁç≤Âèñ +10%" },
        };

        const RPG_ARTIFACTS = [
            // Common (Start)
            { id: 'wand_1', name: 'Â≠∏ÂæíÊ≥ïÊùñ', type: 'weapon', val: 5, tier: 1, cost: 50, icon: Zap, desc: 'ÊîªÊìäÂäõ +5', unlockCost: 0, effect: (p) => ({ ...p, atk: p.atk + 5 }) },
            { id: 'robe_1', name: 'Â∏ÉË°£', type: 'armor', val: 20, tier: 1, cost: 50, icon: Shield, desc: 'ÊúÄÂ§ß HP +20', unlockCost: 0, effect: (p) => ({ ...p, maxHp: p.maxHp + 20, hp: p.hp + 20 }) },
            { id: 'ring_1', name: 'ÂäõÈáèÊàíÊåá', type: 'accessory', val: 5, tier: 1, cost: 60, icon: Star, desc: 'ÊîªÊìäÂäõ +5', unlockCost: 0, effect: (p) => ({ ...p, atk: p.atk + 5 }) },
            { id: 'boots_1', name: 'ËºïÈùà‰πãÈù¥', type: 'accessory', val: 0.05, tier: 1, cost: 60, icon: Wind, desc: 'ÈñÉÈÅøÁéá +5%', unlockCost: 0, effect: (p) => ({ ...p, dodge: p.dodge + 0.05 }) },
            // Rare (Tier 2) - Vampire / Berserker / Tank
            { id: 'vamp_tooth', name: 'Âê∏Ë°ÄÈ¨º‰πãÁâô', type: 'special', val: 0.1, tier: 2, cost: 150, icon: Droplets, desc: 'Âê∏Ë°Ä +10%', unlockCost: 500, effect: (p) => ({ ...p, lifesteal: p.lifesteal + 0.1 }) },
            { id: 'sharp_stone', name: 'Èõ∑Á•ûÁ£®ÂàÄÁü≥', type: 'special', val: 0.15, tier: 2, cost: 150, icon: Zap, desc: 'Êö¥ÊìäÁéá +15%', unlockCost: 400, effect: (p) => ({ ...p, critChance: p.critChance + 0.15 }) },
            { id: 'spike_shield', name: 'ËçäÊ£òÁõæÁâå', type: 'special', val: 0.2, tier: 2, cost: 180, icon: Shield, desc: 'ÂèçÂÇ∑ +20%', unlockCost: 450, effect: (p) => ({ ...p, thorns: p.thorns + 0.2, maxHp: p.maxHp + 20 }) },
            { id: 'hourglass', name: 'ÊôÇÂÖâÊ≤ôÊºè', type: 'special', val: 1, tier: 2, cost: 200, icon: Timer, desc: 'ÊäÄËÉΩÂÜ∑Âçª -1', unlockCost: 600, effect: (p) => ({ ...p, cdr: p.cdr + 1 }) },
            { id: 'heavy_plate', name: 'ÈáçÂûãÊùøÁî≤', type: 'armor', val: 50, tier: 2, cost: 120, icon: Shield, desc: 'ÊúÄÂ§ß HP +50, ÈñÉÈÅø -5%', unlockCost: 300, effect: (p) => ({ ...p, maxHp: p.maxHp + 50, hp: p.hp + 50, dodge: Math.max(0, p.dodge - 0.05) }) },
            { id: 'swift_feather', name: 'ÁñæÈ¢®‰πãÁæΩ', type: 'accessory', val: 0.1, tier: 2, cost: 140, icon: Wind, desc: 'ÈñÉÈÅøÁéá +10%', unlockCost: 350, effect: (p) => ({ ...p, dodge: p.dodge + 0.1 }) },
            // Legendary (Tier 3) - Build Defining
            { id: 'cursed_mask', name: 'Ë©õÂííÈù¢ÂÖ∑', type: 'special', val: 0, tier: 3, cost: 300, icon: Skull, desc: 'ÊîªÊìä +50%, HP -20% (ÁãÇÊà∞ÊµÅ)', unlockCost: 1000, effect: (p) => ({ ...p, atk: Math.floor(p.atk * 1.5), maxHp: Math.floor(p.maxHp * 0.8), hp: Math.min(p.hp, Math.floor(p.maxHp * 0.8)) }) },
            { id: 'titan_core', name: 'Ê≥∞Âù¶Ê†∏ÂøÉ', type: 'special', val: 0, tier: 3, cost: 350, icon: Shield, desc: 'Ë≠∑ÁõæËΩâÂåñÁÇ∫ÊîªÊìäÂäõ (Âù¶ÂÖãÊµÅ)', unlockCost: 1200, effect: (p) => ({ ...p, shieldToAtk: true, desc: 'Ë≠∑ÁõæÂä†ÊàêÊîªÊìä' }) },
            { id: 'greedy_pot', name: 'Ë≤™Â©™‰πãÂ£∫', type: 'special', val: 0, tier: 3, cost: 250, icon: Coins, desc: 'ÊØèÊ¨°Êà∞È¨•Â§öÈÅ∏‰∏ÄÂÄãÁçéÂãµ (Âπ∏ÈÅãÊµÅ)', unlockCost: 800, effect: (p) => ({ ...p, extraReward: true }) },
            { id: 'infinity_edge', name: 'ÁÑ°Áõ°‰πãÂàÉ', type: 'weapon', val: 0, tier: 3, cost: 400, icon: Sword, desc: 'Êö¥ÊìäÂÇ∑ÂÆ≥ +100% (ÁàÜÊìäÊµÅ)', unlockCost: 1500, effect: (p) => ({ ...p, critMult: p.critMult + 1.0 }) },
            { id: 'phoenix_ash', name: 'È≥≥Âá∞ÁÅ∞Ááº', type: 'special', val: 0, tier: 3, cost: 500, icon: Flame, desc: 'Ê≠ª‰∫°ÊôÇÂæ©Ê¥ª‰∏ÄÊ¨° (‰∏ÄÊ¨°ÊÄß)', unlockCost: 2000, effect: (p) => ({ ...p, revive: true }) },
        ];

        const MONSTER_TYPES = [
            { name: 'Âè≤ËêäÂßÜ', hpMod: 0.8, atkMod: 0.8, speedMod: 0.8, color: 'text-green-400', icon: Ghost },
            { name: 'ËùôËù†', hpMod: 0.6, atkMod: 1.2, speedMod: 1.5, color: 'text-purple-400', icon: Wind },
            { name: 'Áü≥ÂÉèÈ¨º', hpMod: 1.5, atkMod: 1.0, speedMod: 0.6, color: 'text-stone-400', icon: Shield },
            { name: 'ÊöóÂΩ±Âà∫ÂÆ¢', hpMod: 0.8, atkMod: 1.5, speedMod: 1.2, color: 'text-red-400', icon: Sword },
            { name: 'Â≠óÈùàÈæç', hpMod: 2.5, atkMod: 1.5, speedMod: 1.0, color: 'text-yellow-400', icon: Crown, isBoss: true },
            { name: 'Ê∑±Ê∑µÈ†ò‰∏ª', hpMod: 3.0, atkMod: 1.8, speedMod: 0.8, color: 'text-rose-500', icon: Skull, isBoss: true },
        ];

        const RPG_SKILLS = [
            { id: 'heal', name: 'Ê≤ªÁôíË°ì', baseCd: 4, currentCd: 0, icon: Heart, color: 'bg-green-500', effect: (p) => ({ ...p, hp: Math.min(p.maxHp, p.hp + Math.floor(p.maxHp * 0.3)), log: `ÊñΩÊîæÊ≤ªÁôíË°ìÔºÅÂõûÂæ© ${Math.floor(p.maxHp * 0.3)} HP` }) },
            { id: 'burst', name: 'ÁàÜË£ÇÈ≠îÊ≥ï', baseCd: 6, currentCd: 0, icon: Flame, color: 'bg-red-500', effect: (p) => ({ ...p, bonusDmg: p.atk * 2, log: 'ÁàÜË£ÇÈ≠îÊ≥ïËìÑÂäõÔºÅ‰∏ãÊìäÂÇ∑ÂÆ≥ 200%ÔºÅ' }) },
            { id: 'guard', name: 'ÈêµÂ£Å', baseCd: 5, currentCd: 0, icon: Shield, color: 'bg-blue-500', effect: (p) => ({ ...p, shield: 50, log: 'Áç≤Âæó 50 ÈªûË≠∑ÁõæÔºÅ' }) },
        ];

        // --- üèõÔ∏è Meta Shop Component ---
        const MetaShop = ({ metaState, setMetaState, onBack }) => {
            const buyUpgrade = (type) => {
                const cfg = META_UPGRADES[type];
                const currentLv = metaState.upgrades[type];
                const cost = Math.floor(cfg.baseCost * Math.pow(cfg.costMult, currentLv));
                
                if (metaState.coins >= cost) {
                    AudioEngine.coin();
                    setMetaState(prev => ({
                        ...prev,
                        coins: prev.coins - cost,
                        upgrades: { ...prev.upgrades, [type]: currentLv + 1 }
                    }));
                } else {
                    AudioEngine.wrong();
                }
            };

            const unlockArtifact = (artId, cost) => {
                if (metaState.coins >= cost) {
                    AudioEngine.coin();
                    setMetaState(prev => ({
                        ...prev,
                        coins: prev.coins - cost,
                        unlockedArtifacts: [...prev.unlockedArtifacts, artId]
                    }));
                } else {
                    AudioEngine.wrong();
                }
            };

            return (
                <div className="h-full bg-slate-900 text-white p-6 overflow-y-auto">
                    <div className="flex justify-between items-center mb-8 sticky top-0 bg-slate-900/95 p-4 z-10 border-b border-slate-700">
                        <div className="flex items-center gap-4">
                            <button onClick={onBack} className="bg-slate-700 p-2 rounded-full hover:bg-slate-600"><LucideIcon icon={ArrowLeft} /></button>
                            <h2 className="text-2xl font-bold text-magic-300">Áü•Ë≠òËÅñÊÆø</h2>
                        </div>
                        <div className="flex items-center gap-2 bg-slate-800 px-4 py-2 rounded-full border border-gold-500/50">
                            <LucideIcon icon={Coins} className="text-gold-400" />
                            <span className="font-bold text-xl text-gold-400">{metaState.coins}</span>
                        </div>
                    </div>

                    <div className="max-w-5xl mx-auto space-y-12">
                        {/* Upgrades Section */}
                        <section>
                            <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-magic-100"><LucideIcon icon={GraduationCap} /> Âü∫Á§éËÉΩÂäõÂº∑Âåñ</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {Object.entries(META_UPGRADES).map(([key, cfg]) => {
                                    const lv = metaState.upgrades[key];
                                    const cost = Math.floor(cfg.baseCost * Math.pow(cfg.costMult, lv));
                                    const canAfford = metaState.coins >= cost;
                                    
                                    return (
                                        <div key={key} className="bg-slate-800 p-6 rounded-2xl border border-slate-700 relative overflow-hidden">
                                            <div className="flex items-center gap-4 mb-4">
                                                <div className="p-3 bg-magic-900 rounded-lg"><LucideIcon icon={cfg.icon} size={28} className="text-magic-300" /></div>
                                                <div>
                                                    <div className="font-bold text-lg">{cfg.name}</div>
                                                    <div className="text-xs text-slate-400">Lv.{lv}</div>
                                                </div>
                                            </div>
                                            <p className="text-sm text-slate-300 mb-6">{cfg.desc} (Áï∂Ââç: +{Math.round(cfg.effectVal * lv * 10)/10}{key === 'exp' ? '%' : ''})</p>
                                            <button 
                                                onClick={() => buyUpgrade(key)}
                                                disabled={!canAfford}
                                                className={`w-full py-2 rounded-xl font-bold flex items-center justify-center gap-2 ${canAfford ? 'bg-gold-600 hover:bg-gold-500 text-white' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}
                                            >
                                                <span>ÂçáÁ¥ö</span>
                                                <span className="text-xs bg-black/20 px-2 py-0.5 rounded flex items-center"><LucideIcon icon={Coins} size={12} className="mr-1"/>{cost}</span>
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>

                        {/* Artifacts Section */}
                        <section>
                            <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-magic-100"><LucideIcon icon={Lock} /> ÈÅ∫Áâ©Ëß£Èéñ</h3>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                {RPG_ARTIFACTS.filter(a => a.unlockCost > 0).map(art => {
                                    const isUnlocked = metaState.unlockedArtifacts.includes(art.id);
                                    const canAfford = metaState.coins >= art.unlockCost;

                                    return (
                                        <div key={art.id} className={`p-4 rounded-xl border-2 flex flex-col items-center text-center transition-all ${isUnlocked ? 'bg-magic-900/30 border-magic-500/50' : 'bg-slate-800 border-slate-700'}`}>
                                            <div className={`p-3 rounded-full mb-2 ${isUnlocked ? 'bg-magic-500/20' : 'bg-slate-900'}`}>
                                                <LucideIcon icon={art.icon} className={isUnlocked ? 'text-magic-300' : 'text-slate-600'} />
                                            </div>
                                            <h4 className={`font-bold ${isUnlocked ? 'text-white' : 'text-slate-500'}`}>{art.name}</h4>
                                            <p className="text-xs text-slate-400 mb-4 h-8">{art.desc}</p>
                                            
                                            {isUnlocked ? (
                                                <div className="text-green-400 text-xs font-bold flex items-center"><LucideIcon icon={CheckCircle} size={12} className="mr-1"/> Â∑≤Ëß£Èéñ</div>
                                            ) : (
                                                <button 
                                                    onClick={() => unlockArtifact(art.id, art.unlockCost)}
                                                    disabled={!canAfford}
                                                    className={`px-4 py-1 rounded-lg text-xs font-bold flex items-center ${canAfford ? 'bg-gold-600 text-white hover:bg-gold-500' : 'bg-slate-700 text-slate-500'}`}
                                                >
                                                    <LucideIcon icon={Unlock} size={10} className="mr-1"/> {art.unlockCost}
                                                </button>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </section>
                    </div>
                </div>
            );
        };

        // --- ‚öîÔ∏è RPG Game Component ---
        const RPGGame = ({ difficulty, chapter, onExit, onHome, onLoadGame, initialData, metaState, onGameEnd }) => {
            const baseStats = {
                hp: 100 + (metaState.upgrades.hp * META_UPGRADES.hp.effectVal),
                atk: 20 + (metaState.upgrades.atk * META_UPGRADES.atk.effectVal),
                expMult: 1 + (metaState.upgrades.exp * META_UPGRADES.exp.effectVal)
            };

            const [player, setPlayer] = useState(initialData?.player || {
                hp: baseStats.hp, maxHp: baseStats.hp, atk: baseStats.atk, level: 1, exp: 0, maxExp: 100,
                critChance: 0.1, critMult: 1.5, lifesteal: 0, thorns: 0, dodge: 0, shield: 0, cdr: 0,
                bonusDmg: 0, combo: 0, floor: 1, gold: 0, 
                skills: RPG_SKILLS.map(s => ({...s, currentCd: 0})),
                artifacts: [], coinsGained: 0, revive: false, extraReward: false
            });
            
            const [monster, setMonster] = useState({ hp: 100, maxHp: 100, name: '‰∫ÇÁ¢ºÊÄ™Áç∏', type: MONSTER_TYPES[0] });
            const [attackGauge, setAttackGauge] = useState(0); 
            const [qIndex, setQIndex] = useState(0);
            const [turn, setTurn] = useState('player'); 
            const [userInput, setUserInput] = useState([]);
            const [combatLog, setCombatLog] = useState("Êà∞È¨•ÈñãÂßãÔºÅ");
            const [animation, setAnimation] = useState(null); 
            const [rewards, setRewards] = useState([]); 
            const [shopItems, setShopItems] = useState([]);
            const [showStats, setShowStats] = useState(false);

            // Filter questions by Chapter Code (e.g. 'A', 'B')
            const filteredQuestions = useMemo(() => {
                if (!chapter) return QUESTIONS;
                return QUESTIONS.filter(q => q.mainCode === chapter);
            }, [chapter]);
            
            const activeQuestions = filteredQuestions.length > 0 ? filteredQuestions : QUESTIONS;
            // Randomize question
            const currentQ = useMemo(() => activeQuestions[Math.floor(Math.random() * activeQuestions.length)], [qIndex, activeQuestions]);

            const currentOptions = useMemo(() => {
                if (difficulty === 'advanced') return [];
                const correctOption = difficulty === 'beginner' 
                    ? { label: `${KEYBOARD_MAP[currentQ.first]} (${currentQ.first})`, val: currentQ.first, isCorrect: true }
                    : { label: `${KEYBOARD_MAP[currentQ.first]} + ${KEYBOARD_MAP[currentQ.last]}`, val: currentQ.code, isCorrect: true };

                const safeDecoys = currentQ.decoys.filter(d => difficulty === 'beginner' ? d.code[0] !== currentQ.first : d.code !== currentQ.code);
                const decoyOptions = safeDecoys.slice(0, 2).map(d => {
                    if (difficulty === 'beginner') {
                        const firstCode = d.code[0];
                        return { label: `${d.char} (${firstCode})`, val: firstCode, isCorrect: false };
                    } else {
                        const first = d.code[0];
                        const last = d.code[d.code.length - 1];
                        return { label: `${d.char} (${first}+${last})`, val: first+last, isCorrect: false };
                    }
                });

                return [correctOption, ...decoyOptions].sort(() => Math.random() - 0.5);
            }, [qIndex, difficulty, currentQ]);

            useEffect(() => { if (!initialData) spawnMonster(); }, []);

            const spawnMonster = () => {
                const isBoss = player.floor % 5 === 0;
                const pool = MONSTER_TYPES.filter(m => isBoss ? m.isBoss : !m.isBoss);
                const type = pool[Math.floor(Math.random() * pool.length)];
                const scale = 1 + (player.floor * 0.25); 
                const hp = Math.floor(100 * type.hpMod * scale);
                const name = `${isBoss ? '„ÄêBOSS„Äë' : ''}${type.name} (F${player.floor})`;
                setMonster({ hp, maxHp: hp, name, type });
                setAttackGauge(0);
                setCombatLog(`F${player.floor}: ÈÅ≠ÈÅá ${name}ÔºÅ`);
            };

            const saveGame = () => {
                const data = JSON.stringify({ player, difficulty, date: new Date().toISOString() });
                const blob = new Blob([data], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `word_battler_f${player.floor}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                setCombatLog("ÈÄ≤Â∫¶Â∑≤ÂÑ≤Â≠òÔºÅ");
            };
            
            const handleGameOver = (isWin) => {
                setTurn(isWin ? 'win' : 'lose');
                if (!isWin) AudioEngine.lose(); else AudioEngine.win();
            };

            // Combat Loop
            useEffect(() => {
                let interval;
                if (turn === 'player') {
                    interval = setInterval(() => {
                        setAttackGauge(prev => {
                            if (prev >= 100) {
                                const baseDmg = 10 + (player.floor * 2);
                                const finalDmg = Math.floor(baseDmg * monster.type.atkMod);
                                handlePlayerDamage(finalDmg, `${monster.type.name} ÊîªÊìäÔºÅ`);
                                return 0;
                            }
                            let inc = 2.5 * monster.type.speedMod;
                            if (difficulty === 'intermediate') inc *= 0.7;
                            if (difficulty === 'advanced') inc *= 0.4;
                            return prev + inc;
                        });
                    }, 200);
                }
                return () => clearInterval(interval);
            }, [turn, difficulty, monster, player.floor]);

            const handlePlayerDamage = (rawDmg, reason) => {
                if (Math.random() < player.dodge) { setCombatLog(`${reason} MISS!`); return; }
                AudioEngine.hit();
                setAnimation('damage');
                let damage = Math.max(0, rawDmg - player.shield);
                const remainingShield = Math.max(0, player.shield - rawDmg);
                if (player.thorns > 0) { const thornsDmg = Math.floor(rawDmg * player.thorns); setMonster(m => ({ ...m, hp: Math.max(0, m.hp - thornsDmg) })); }
                setPlayer(p => ({ ...p, hp: Math.max(0, p.hp - damage), shield: remainingShield, combo: 0 }));
                setCombatLog(`${reason} ÂèóÂà∞ ${damage} ÂÇ∑ÂÆ≥ÔºÅ`);
                setTimeout(() => { setAnimation(null); if (player.hp - damage <= 0) { if (player.revive) { setPlayer(p => ({ ...p, hp: p.maxHp, revive: false })); setCombatLog("È≥≥Âá∞ÁÅ∞ÁáºËß∏ÁôºÔºÅ"); setAnimation('heal'); } else handleGameOver(false); } }, 300);
            };

            const resolvePlayerAttack = () => {
                const comboMult = 1 + (player.combo * 0.1);
                let atkVal = player.atk;
                if (player.shieldToAtk && player.shield > 0) atkVal += Math.floor(player.shield * 0.5);
                let damage = (atkVal + player.bonusDmg) * comboMult;
                let isCrit = Math.random() < player.critChance;
                if (isCrit) { damage *= player.critMult; AudioEngine.crit(); } else AudioEngine.attack();
                damage = Math.floor(damage);
                if (player.lifesteal > 0) setPlayer(p => ({ ...p, hp: Math.min(p.maxHp, p.hp + Math.floor(damage * player.lifesteal)) }));
                setPlayer(p => ({ ...p, bonusDmg: 0, combo: p.combo + 1, skills: p.skills.map(s => ({ ...s, currentCd: Math.max(0, s.currentCd - 1) })) })); 
                setMonster(m => ({ ...m, hp: Math.max(0, m.hp - damage) }));
                setCombatLog(`${isCrit ? 'ÊúÉÂøÉÔºÅ' : 'ÂëΩ‰∏≠ÔºÅ'} -${damage}`);
                setAttackGauge(prev => Math.max(0, prev - 10));
                if (monster.hp - damage <= 0) setTimeout(handleMonsterDefeat, 600); else setTimeout(() => setUserInput([]), 600);
            };

            const handleSkill = (skillId) => {
                if (turn !== 'player') return;
                const idx = player.skills.findIndex(s => s.id === skillId);
                const skill = player.skills[idx];
                if (skill.currentCd > 0) return;
                AudioEngine.skill();
                const updatedSkills = [...player.skills];
                const cooldown = Math.max(1, skill.baseCd - player.cdr);
                updatedSkills[idx] = { ...skill, currentCd: cooldown };
                let newP = { ...player, skills: updatedSkills };
                let log = '';
                if (skill.id === 'heal') { const v = Math.floor(newP.maxHp * 0.3); newP.hp = Math.min(newP.maxHp, newP.hp + v); log = `ÂõûÂæ© ${v} HP`; }
                else if (skill.id === 'burst') { newP.bonusDmg = newP.atk * 2; log = '‰∏ãÊìäÂÇ∑ÂÆ≥ 200%'; }
                else if (skill.id === 'guard') { newP.shield += 50; log = 'Ë≠∑Áõæ +50'; }
                setPlayer(newP); setCombatLog(log); setAnimation('heal'); setTimeout(() => setAnimation(null), 800);
            };

            const handleMonsterDefeat = () => {
                AudioEngine.levelUp();
                const expGain = Math.floor((50 + (player.floor * 10)) * baseStats.expMult);
                const coinGain = 15 + Math.floor(player.floor * 3);
                let newExp = player.exp + expGain;
                let newLevel = player.level;
                let newMaxExp = player.maxExp;
                let leveledUp = false;
                if (newExp >= player.maxExp) { newExp -= player.maxExp; newLevel++; newMaxExp = Math.floor(newMaxExp * 1.2); leveledUp = true; }
                setPlayer(p => ({ ...p, exp: newExp, level: newLevel, maxExp: newMaxExp, maxHp: leveledUp ? p.maxHp + 10 : p.maxHp, atk: leveledUp ? p.atk + 2 : p.atk, hp: leveledUp ? p.maxHp : p.hp, floor: p.floor + 1, coinsGained: p.coinsGained + coinGain, gold: p.gold + coinGain }));
                const numChoices = player.extraReward ? 6 : 5;
                const availableArtifacts = RPG_ARTIFACTS.filter(a => a.unlockCost === 0 || metaState.unlockedArtifacts.includes(a.id));
                const pool = availableArtifacts.sort(() => 0.5 - Math.random()).slice(0, numChoices);
                setRewards(pool);
                setTurn('reward');
            };

            const handleSelectReward = (reward) => {
                AudioEngine.correct();
                const newP = reward.effect(player);
                const safeArtifact = { id: reward.id, name: reward.name, icon: reward.icon, desc: reward.desc };
                setPlayer({ ...newP, artifacts: [...newP.artifacts, safeArtifact] });
                determineNextEvent();
            };

            const determineNextEvent = () => {
                const roll = Math.random();
                if (player.floor % 5 === 0) { 
                    const nextFloor = player.floor + 1;
                    setPlayer(p => ({...p, floor: nextFloor}));
                    if (nextFloor % 3 === 0) generateShop();
                    else if (roll < 0.2) setTurn('camp');
                    else nextBattle();
                } else {
                     const nextFloor = player.floor + 1;
                     setPlayer(p => ({...p, floor: nextFloor}));
                     if (roll < 0.1) generateShop();
                     else if (roll < 0.25) setTurn('camp');
                     else nextBattle();
                }
            };

            const nextBattle = () => {
                setQIndex(q => q + 1); spawnMonster(); setUserInput([]); setTurn('player');
            };

            const generateShop = () => {
                const shopPool = RPG_ARTIFACTS.filter(a => a.unlockCost === 0 || metaState.unlockedArtifacts.includes(a.id)).sort(() => 0.5 - Math.random()).slice(0, 3);
                setShopItems([
                    ...shopPool.map(i => ({ ...i, price: Math.floor(i.cost * (0.8 + Math.random()*0.4)) })),
                    { id: 'potion', name: 'Â§ßÁ¥ÖËó•Ê∞¥', type: 'consumable', val: 100, price: 30, icon: Coffee, desc: 'ÂõûÂæ© 100 HP', effect: (p)=>({...p, hp: Math.min(p.maxHp, p.hp+100)}) }
                ]);
                setTurn('shop');
            };

            const handleShopBuy = (item) => {
                if (player.gold >= item.price) {
                    AudioEngine.coin();
                    const newP = item.effect(player);
                    if (item.type !== 'consumable') newP.artifacts = [...newP.artifacts, { id: item.id, name: item.name, icon: item.icon, desc: item.desc }];
                    setPlayer({ ...newP, gold: newP.gold - item.price });
                    setShopItems(prev => prev.filter(i => i !== item));
                } else AudioEngine.wrong();
            };

            const handleCampAction = (action) => {
                AudioEngine.heal();
                if (action === 'rest') {
                    setPlayer(p => ({ ...p, hp: Math.min(p.maxHp, p.hp + Math.floor(p.maxHp * 0.5)) }));
                    setCombatLog("‰ºëÊÅØ‰∫Ü‰∏ÄÊôöÔºåÁ≤æÁ•ûÁôæÂÄçÔºÅ");
                } else {
                    setPlayer(p => ({ ...p, maxHp: p.maxHp + 10, atk: p.atk + 2 }));
                    setCombatLog("Á∂ìÈÅéÈçõÈçäÔºåËÆäÂæóÊõ¥Âº∑‰∫ÜÔºÅ");
                }
                setTimeout(nextBattle, 1000);
            };

            const handleAttack = (val) => { if (turn!=='player') return; const isCorrect = (difficulty==='beginner'&&val===currentQ.first)||(difficulty==='intermediate'&&val===currentQ.code); if(isCorrect) resolvePlayerAttack(); else handlePlayerDamage(5, "Ëº∏ÂÖ•ÈåØË™§ÔºÅ"); };
            const handleKeyClick = (k) => { if (turn!=='player') return; if(userInput.length===0){if(k===currentQ.first){AudioEngine.click();setUserInput([k]);}else{handlePlayerDamage(5, "È¶ñÁ¢ºÈåØË™§");setUserInput([]);}}else if(userInput.length===1){if(k===currentQ.last){setUserInput([...userInput,k]);resolvePlayerAttack();}else{handlePlayerDamage(5, "Â∞æÁ¢ºÈåØË™§");}} };
            useEffect(() => { if (difficulty!=='advanced') return; const h = (e) => { const k=e.key.toUpperCase(); if(/^[A-Z]$/.test(k)) handleKeyClick(k); }; window.addEventListener('keydown', h); return () => window.removeEventListener('keydown', h); }, [difficulty, turn, userInput, currentQ]);

            const renderInput = () => {
                if (difficulty === 'advanced') {
                    const keys = "QWERTYUIOPASDFGHJKLZXCVBNM".split('');
                    return <div className="w-full max-w-3xl mx-auto p-2"><div className="flex justify-center mb-4 space-x-2"><div className={`w-12 h-12 border-2 rounded flex items-center justify-center text-2xl font-bold bg-slate-800 border-magic-500 text-magic-300`}>{userInput[0] && KEYBOARD_MAP[userInput[0]]}</div><div className={`w-12 h-12 border-2 rounded flex items-center justify-center text-2xl font-bold bg-slate-800 border-magic-500 text-magic-300`}>{userInput[1] && KEYBOARD_MAP[userInput[1]]}</div></div><div className="keyboard-grid">{keys.map(k => <button key={k} onClick={() => handleKeyClick(k)} className="aspect-square bg-slate-800 border border-slate-700 rounded flex flex-col items-center justify-center hover:bg-slate-700 active:bg-slate-600"><span className="text-xs text-slate-500">{k}</span><span className="text-magic-300 font-bold">{KEYBOARD_MAP[k]}</span></button>)}</div></div>;
                }
                return <div className="grid grid-cols-3 gap-4 max-w-2xl mx-auto">{currentOptions.map((o,i) => <button key={i} onClick={() => handleAttack(o.val)} className="bg-slate-800 border-2 border-magic-600 py-6 rounded-xl text-xl font-bold text-magic-100 active:scale-95 hover:bg-slate-700">{o.label}</button>)}</div>;
            };

            if (turn === 'lose') return <div className="absolute inset-0 bg-slate-950 flex flex-col items-center justify-center text-white p-8 z-50"><LucideIcon icon={Skull} size={80} className="text-red-500 mb-6" /><h2 className="text-4xl font-bold mb-2 text-red-500">ÊåëÊà∞ÁµêÊùü</h2><p className="text-xl mb-4">Ê≠¢Ê≠•ÊñºÁ¨¨ {player.floor} Â±§</p><div className="bg-slate-800 p-6 rounded-2xl mb-8 flex flex-col items-center border border-gold-500/30"><p className="text-sm text-gold-400 mb-2">Êú¨Ê¨°Áç≤Âæó</p><div className="flex items-center gap-2 text-3xl font-bold text-yellow-400"><LucideIcon icon={Coins} /> <span>{player.coinsGained + (player.floor * 5)}</span></div></div><button onClick={() => onGameEnd(player.coinsGained)} className="bg-slate-700 hover:bg-slate-600 px-8 py-3 rounded-full font-bold">ËøîÂõûËÅñÊÆø</button></div>;

            if (turn === 'shop') return (
                <div className="absolute inset-0 bg-slate-950 flex flex-col items-center justify-center text-white p-8 z-50">
                    <h2 className="text-3xl font-bold text-gold-400 mb-4 flex items-center gap-2"><LucideIcon icon={ShoppingBag}/> Á•ûÁßòÂïÜÂ∫ó</h2>
                    <p className="mb-6 text-slate-400">ÊåÅÊúâÈáëÂπ£: <span className="text-yellow-400 font-bold">{player.gold}</span></p>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 w-full max-w-5xl">
                        {shopItems.map((item, i) => (
                            <button key={i} onClick={() => handleShopBuy(item)} disabled={player.gold < item.price} className={`p-4 rounded-xl border-2 flex flex-col items-center transition-all ${player.gold >= item.price ? 'bg-slate-800 border-gold-600 hover:bg-slate-700' : 'bg-slate-900 border-slate-700 opacity-50'}`}>
                                <LucideIcon icon={item.icon} size={32} className="text-gold-400 mb-2" />
                                <h4 className="font-bold">{item.name}</h4>
                                <p className="text-xs text-slate-400 mb-2">{item.desc}</p>
                                <span className="text-yellow-400 font-bold flex items-center"><LucideIcon icon={Coins} size={12} className="mr-1"/> {item.price}</span>
                            </button>
                        ))}
                    </div>
                    <button onClick={nextBattle} className="mt-8 bg-brand-600 hover:bg-brand-500 px-8 py-3 rounded-full font-bold">Èõ¢ÈñãÂïÜÂ∫ó</button>
                </div>
            );

            if (turn === 'camp') return (
                <div className="absolute inset-0 bg-slate-950 flex flex-col items-center justify-center text-white p-8 z-50">
                    <LucideIcon icon={Tent} size={80} className="text-green-500 mb-6" />
                    <h2 className="text-3xl font-bold mb-8">‰ºëÊÅØÁáüÂú∞</h2>
                    <div className="flex gap-6">
                        <button onClick={() => handleCampAction('rest')} className="bg-slate-800 border-2 border-green-600 p-8 rounded-2xl hover:bg-slate-700 transition-all flex flex-col items-center w-48">
                            <LucideIcon icon={BedDouble} size={48} className="text-green-400 mb-4" />
                            <h3 className="text-xl font-bold">‰ºëÊÅØ</h3>
                            <p className="text-sm text-slate-400 mt-2">ÂõûÂæ© 50% HP</p>
                        </button>
                        <button onClick={() => handleCampAction('train')} className="bg-slate-800 border-2 border-red-600 p-8 rounded-2xl hover:bg-slate-700 transition-all flex flex-col items-center w-48">
                            <LucideIcon icon={Dumbbell} size={48} className="text-red-400 mb-4" />
                            <h3 className="text-xl font-bold">ÈçõÈçä</h3>
                            <p className="text-sm text-slate-400 mt-2">HP+10, ATK+2</p>
                        </button>
                    </div>
                </div>
            );

            if (turn === 'reward') return ( 
                <div className="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center text-white p-4 z-50">
                    <h2 className="text-3xl font-bold text-yellow-400 mb-8 animate-bounce">Êà∞Âà©ÂìÅÈÅ∏Êìá</h2>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 max-w-6xl w-full">
                        {rewards.map((r, i) => (
                            <button key={i} onClick={() => handleSelectReward(r)} className="bg-slate-800 border-2 border-magic-600 hover:scale-105 transition-transform p-4 rounded-xl flex flex-col items-center shadow-xl group h-full">
                                <LucideIcon icon={r.icon} size={36} className="text-yellow-400 mb-3 group-hover:scale-110 transition-transform" />
                                <h3 className="text-lg font-bold mb-1 text-center leading-tight">{r.name}</h3>
                                <p className="text-xs text-slate-300 text-center flex-1 flex items-center justify-center">{r.desc}</p>
                            </button>
                        ))}
                    </div>
                </div> 
            );

            return (
                <div className={`h-full w-full flex flex-col bg-slate-950 text-white font-sans relative overflow-hidden ${animation === 'damage' ? 'animate-damage-flash' : ''}`}>
                    {/* Header */}
                    <div className="p-3 bg-slate-900/90 border-b border-slate-800 flex justify-between items-center z-10">
                        <div className="flex items-center gap-4 cursor-pointer hover:bg-slate-800/50 rounded-lg p-1" onClick={() => setShowStats(!showStats)}>
                            <div className="w-12 h-12 bg-magic-700 rounded-lg flex flex-col items-center justify-center border-2 border-magic-500">
                                <span className="text-xs">LV</span><span className="font-bold text-xl">{player.level}</span>
                            </div>
                            <div>
                                <div className="text-xs text-slate-400">Floor {player.floor}</div>
                                <div className="w-32 h-3 bg-slate-800 rounded-full overflow-hidden relative"><div className="h-full bg-red-500 transition-all duration-300" style={{width: `${(player.hp/player.maxHp)*100}%`}}></div>{player.shield>0 && <div className="absolute top-0 h-full bg-blue-400/50" style={{width: `${(player.shield/player.maxHp)*100}%`}}/>}</div>
                                <div className="text-[10px] text-right">{player.hp}/{player.maxHp}</div>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-1 text-gold-400 font-bold bg-slate-800 px-3 py-1 rounded-full text-sm border border-slate-700"><LucideIcon icon={Coins} size={14}/> {player.gold}</div>
                            <button onClick={saveGame} className="p-2 bg-slate-800 rounded border border-slate-600"><LucideIcon icon={Save} size={18}/></button>
                            <button onClick={() => handleGameOver(false)} className="p-2 bg-red-900/50 text-red-400 rounded hover:bg-red-900"><LucideIcon icon={X} size={18}/></button>
                        </div>
                    </div>
                    {showStats && <div className="absolute top-20 left-4 bg-slate-900/95 border border-slate-700 p-4 rounded-xl z-40 text-sm shadow-xl min-w-[200px]" onClick={()=>setShowStats(false)}><h4 className="font-bold border-b border-slate-700 mb-2 pb-1 text-magic-300">Â±¨ÊÄß</h4><p>‚öîÔ∏è {player.atk} | ‚ö° {Math.round(player.critChance*100)}% | ü©∏ {Math.round(player.lifesteal*100)}% | üí® {Math.round(player.dodge*100)}%</p><h4 className="font-bold border-b border-slate-700 mb-2 pb-1 mt-2 text-magic-300">ÈÅ∫Áâ©</h4><div className="flex flex-wrap gap-1">{player.artifacts.map((a,i)=><div key={i} title={a.name} className="bg-slate-800 p-1.5 rounded border border-slate-600"><LucideIcon icon={a.icon} size={16} className="text-yellow-500"/></div>)}</div></div>}
                    <div className="flex-1 relative flex flex-col items-center justify-center">
                        <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-magic-900/30 to-slate-950 -z-10"></div>
                        <div className="absolute top-4 flex gap-4 z-20">{player.skills.map(s => (<button key={s.id} onClick={() => handleSkill(s.id)} disabled={s.currentCd > 0} className={`w-14 h-14 rounded-full border-2 flex items-center justify-center relative transition-transform active:scale-95 ${s.currentCd > 0 ? 'bg-slate-800 border-slate-600 opacity-50 cursor-not-allowed' : `${s.color} border-white shadow-lg`}`}><LucideIcon icon={s.icon} size={24} className="text-white" />{s.currentCd > 0 && <div className="absolute inset-0 bg-black/60 rounded-full flex items-center justify-center font-bold text-white">{s.currentCd}</div>}</button>))}</div>
                        <motion.div animate={{ y: [0, -10, 0] }} transition={{ repeat: Infinity, duration: 3 }} className="relative z-10 mt-8 mb-4">
                            <div className="w-40 h-40 bg-slate-800 rounded-full border-4 border-magic-500 flex items-center justify-center shadow-[0_0_30px_rgba(139,92,246,0.4)]"><LucideIcon icon={monster.type.icon} size={80} className={monster.type.color} /><span className="absolute text-7xl font-serif font-black text-white drop-shadow-md">{currentQ.char}</span></div>
                            <div className="absolute -bottom-6 left-1/2 transform -translate-x-1/2 w-32 h-2 bg-slate-800 rounded-full overflow-hidden border border-slate-600"><motion.div className="h-full bg-red-500" style={{ width: `${attackGauge}%` }} transition={{ ease: 'linear', duration: 0.2 }} /></div>
                            <div className="absolute -top-8 w-full text-center text-red-400 font-bold text-sm">{monster.name}</div>
                        </motion.div>
                        <div className="text-center h-8 font-bold text-lg text-magic-200">{combatLog}</div>
                    </div>
                    <div className="bg-slate-900 border-t border-slate-800 p-6 rounded-t-3xl shadow-2xl"><div className="max-w-4xl mx-auto text-center">{renderInput()}</div></div>
                </div>
            );
        };

        // --- üèÉ Runner Game (Refactored to use Chapter) ---
        const RunnerGame = ({ difficulty, chapter, onExit, onHome, currentTheme, user }) => {
            const [score, setScore] = useState(0);
            const [time, setTime] = useState(0);
            const [qIndex, setQIndex] = useState(0);
            const [gameState, setGameState] = useState('running');
            const [userInput, setUserInput] = useState([]);
            const [feedback, setFeedback] = useState(null);
            const [message, setMessage] = useState(null);
            const [qStartTime, setQStartTime] = useState(null);
            
            const filteredQuestions = useMemo(() => {
                if (!chapter) return QUESTIONS;
                return QUESTIONS.filter(q => q.mainCode === chapter);
            }, [chapter]);
            
            const activeQuestions = filteredQuestions.length > 0 ? filteredQuestions : QUESTIONS;
            // Randomize question
            const currentQ = useMemo(() => activeQuestions[Math.floor(Math.random() * activeQuestions.length)], [qIndex, chapter]);
            
            const charProgress = (qIndex / 10) * 80; // Scale progress visually
            const charPosition = gameState === 'win' ? 90 : 10 + charProgress;

            useEffect(() => {
                let interval; if (gameState !== 'win') interval = setInterval(() => setTime(t => t + 1), 1000);
                return () => clearInterval(interval);
            }, [gameState]);

            useEffect(() => {
                let timer; if (gameState === 'running') timer = setTimeout(() => { setGameState('bullet_time'); setQStartTime(Date.now()); }, 2000);
                return () => clearTimeout(timer);
            }, [gameState, qIndex]);

            // Copy logic from RPGGame for options
            const currentOptions = useMemo(() => {
                if (difficulty === 'advanced') return [];
                const correct = difficulty === 'beginner' 
                    ? { label: `${KEYBOARD_MAP[currentQ.first]} (${currentQ.first})`, val: currentQ.first, isCorrect: true }
                    : { label: `${KEYBOARD_MAP[currentQ.first]} + ${KEYBOARD_MAP[currentQ.last]}`, val: currentQ.code, isCorrect: true };
                const safeDecoys = currentQ.decoys.filter(d => difficulty === 'beginner' ? d.code[0] !== currentQ.first : d.code !== currentQ.code);
                const decoyOptions = safeDecoys.slice(0, 2).map(d => {
                    if (difficulty === 'beginner') return { label: `${d.char} (${d.code[0]})`, val: d.code[0], isCorrect: false };
                    return { label: `${d.char} (${d.code[0]}+${d.code[d.code.length-1]})`, val: d.code[0]+d.code[d.code.length-1], isCorrect: false };
                });
                return [correct, ...decoyOptions].sort(() => Math.random() - 0.5);
            }, [qIndex, difficulty, currentQ]);

            const handleOptionClick = (val) => {
                if (feedback === 'correct') return;
                let isCorrect = false;
                if (difficulty === 'beginner') isCorrect = val === currentQ.first;
                else if (difficulty === 'intermediate') isCorrect = val === currentQ.code;
                if (isCorrect) processAnswer(true);
                else { AudioEngine.wrong(); setFeedback('wrong'); setMessage(`ÂÜçË©¶‰∏ÄÊ¨°ÔºÅ`); setTimeout(() => { setFeedback(null); setMessage(null); }, 1000); }
            };

            const handleKeyClick = (key) => {
                if (gameState !== 'bullet_time' || difficulty !== 'advanced' || feedback === 'correct') return;
                if (userInput.length === 0) {
                    if (key === currentQ.first) { AudioEngine.click(); setUserInput([key]); setMessage(null); setFeedback(null); }
                    else { AudioEngine.wrong(); setFeedback('wrong-first'); setMessage(`È¶ñÁ¢ºÈåØË™§ÔºÅÊèêÁ§∫Ôºö${currentQ.hint}`); setUserInput([key]); setTimeout(() => { if (userInput.length <= 1) { setFeedback(null); setMessage(null); setUserInput([]); } }, 1000); }
                } else if (userInput.length === 1) {
                    if (key === currentQ.last) { setUserInput([...userInput, key]); processAnswer(true); }
                    else { AudioEngine.wrong(); setFeedback('wrong-second'); setMessage(`Â∞æÁ¢ºÈåØË™§ÔºÅÊèêÁ§∫Ôºö${currentQ.hint}`); setTimeout(() => { setFeedback(null); setMessage(null); }, 1000); }
                }
            };

            useEffect(() => {
                if (difficulty !== 'advanced') return;
                const h = (e) => { const k = e.key.toUpperCase(); if (/^[A-Z]$/.test(k)) handleKeyClick(k); };
                window.addEventListener('keydown', h); return () => window.removeEventListener('keydown', h);
            }, [difficulty, gameState, userInput, feedback]);

            const processAnswer = () => {
                AudioEngine.correct(); setFeedback('correct'); setMessage(null);
                const speedBonus = Math.max(0, Math.floor(50 - ((Date.now() - qStartTime)/1000) * 5));
                setScore(s => s + 100 + speedBonus);
                setTimeout(() => { setFeedback(null); setUserInput([]); setQIndex(q => q + 1); setGameState('running'); }, 1000);
            };

            const renderOptions = () => {
                if (difficulty === 'advanced') {
                    const keys = "QWERTYUIOPASDFGHJKLZXCVBNM".split('');
                    return <div className="w-full max-w-3xl mx-auto p-2"><div className="flex justify-center mb-4 space-x-2"><div className={`w-12 h-12 border-2 rounded flex items-center justify-center text-2xl font-bold transition-colors duration-300 ${userInput.length >= 1 ? 'bg-green-100 border-green-500 text-green-700' : 'bg-white border-slate-300 text-slate-300'} ${feedback === 'wrong-first' ? '!bg-red-100 !border-red-500 !text-red-700 animate-shake' : ''}`}>{userInput[0] && KEYBOARD_MAP[userInput[0]]}</div><div className={`w-12 h-12 border-2 rounded flex items-center justify-center text-2xl font-bold bg-white transition-colors duration-300 ${userInput[1] ? 'border-brand-500 text-brand-600' : 'border-slate-300 text-slate-300'} ${feedback === 'wrong-second' ? '!bg-red-100 !border-red-500 !text-red-700 animate-shake' : ''}`}>{userInput[1] && KEYBOARD_MAP[userInput[1]]}</div></div><div className="keyboard-grid">{keys.map(k => (<button key={k} onClick={() => handleKeyClick(k)} className={`aspect-square rounded-md shadow-sm border flex flex-col items-center justify-center transition-colors ${userInput.length === 0 && userInput.includes(k) && feedback === 'wrong-first' ? 'bg-red-100 border-red-300' : 'bg-white border-slate-200 active:bg-brand-100'} ${userInput.length > 0 && userInput[0] === k ? 'bg-green-50 border-green-200' : ''}`}><span className="text-xs font-bold text-slate-400">{k}</span><span className="text-lg font-bold font-serif text-slate-800">{KEYBOARD_MAP[k]}</span></button>))}</div></div>;
                }
                return <div className="grid grid-cols-3 gap-4 w-full max-w-2xl mx-auto">{currentOptions.map((opt, i) => (<button key={i} onClick={() => handleOptionClick(opt.val)} className={`relative py-6 rounded-2xl text-xl font-bold shadow-lg transform transition-all active:scale-95 flex items-center justify-center overflow-hidden ${feedback === 'correct' && opt.isCorrect ? 'bg-green-500 text-white' : 'bg-white text-slate-800 hover:bg-brand-50'} ${feedback === 'wrong' && !opt.isCorrect ? 'opacity-50 bg-red-50' : ''}`}><span className={`absolute left-3 top-2 text-2xl font-black opacity-20 ${feedback === 'correct' && opt.isCorrect ? 'text-white' : 'text-slate-900'}`}>{String.fromCharCode(65 + i)}</span><span>{opt.label}</span></button>))}</div>;
            };

            return (
                <div className={`h-full w-full flex flex-col ${currentTheme.bg} overflow-hidden relative`}>
                    <div className="absolute top-0 left-0 right-0 p-4 flex justify-between items-start z-30 pointer-events-none"><div className="flex items-center space-x-2 pointer-events-auto"><button onClick={onExit} className="bg-white/80 p-2 rounded-full shadow-md mr-2"><LucideIcon icon={ArrowLeft} size={20} /></button><div className="flex items-center space-x-2 bg-white/80 backdrop-blur px-3 py-1 rounded-full shadow-sm min-w-[80px]"><LucideIcon icon={Timer} className="text-blue-500 fill-current" size={18} /><span className="font-bold text-slate-800 font-mono">{Math.floor(time / 60).toString().padStart(2, '0')}:{ (time % 60).toString().padStart(2, '0') }</span></div><div className="flex items-center space-x-2 bg-white/80 backdrop-blur px-3 py-1 rounded-full shadow-sm"><LucideIcon icon={Star} className="text-yellow-500 fill-current" size={18} /><span className="font-bold text-slate-800">{score}</span></div></div><button onClick={onHome} className="bg-brand-500 text-white p-2 rounded-full shadow-md pointer-events-auto hover:bg-brand-600 transition-colors"><LucideIcon icon={Home} size={20} /></button></div>
                    <div className="relative h-[45%] flex flex-col justify-end overflow-hidden">
                        <div className="absolute top-10 right-10 text-slate-400/50"><LucideIcon icon={currentTheme.decor} size={64} /></div><div className="absolute top-20 left-10 text-slate-400/30"><LucideIcon icon={Cloud} size={48} /></div><div className={`absolute bottom-0 w-full h-1/2 bg-gradient-to-b ${currentTheme.road} perspective-road flex justify-center`}><div className={`w-4 h-full bg-white/30 ${gameState === 'running' ? 'animate-pulse' : ''}`}></div></div><div className="absolute bottom-10 right-[5%] z-10 flex flex-col items-center"><div className="h-24 w-2 bg-slate-400"></div><LucideIcon icon={Flag} size={48} className="text-red-500 fill-current" /></div><div className={`absolute bottom-4 w-full flex justify-between px-10 ${gameState === 'running' ? 'animate-run' : ''} opacity-50`}><LucideIcon icon={Trees} size={32} className="text-green-800" /><LucideIcon icon={Trees} size={32} className="text-green-800" /></div>
                        <div className="absolute bottom-8 z-20 transition-all duration-1000 ease-in-out" style={{ left: `${charPosition}%` }}><div className="relative transform -translate-x-1/2"><motion.div animate={gameState === 'running' ? { y: [0, -10, 0] } : { y: 0 }} transition={{ repeat: Infinity, duration: 0.5 }}><div style={{ transform: 'scaleX(-1)', display: 'inline-block' }} className={`text-6xl filter drop-shadow-2xl transition-all ${feedback === 'wrong' ? 'animate-shake grayscale' : ''}`}>{feedback === 'wrong' ? 'üòµ' : 'üèÉ'}</div></motion.div><div className="w-16 h-4 bg-black/20 rounded-full mx-auto blur-sm mt-[-5px]"></div><AnimatePresence><motion.div key={qIndex} initial={{ scale: 0, y: 50, opacity: 0 }} animate={{ scale: gameState === 'bullet_time' ? 1 : 0.2, y: gameState === 'bullet_time' ? -100 : 20, opacity: gameState === 'bullet_time' ? 1 : 0 }} transition={{ type: 'spring', damping: 20 }} className="absolute bottom-0 left-1/2 transform -translate-x-1/2 z-30 mb-12"><div className={`bg-white border-8 border-slate-800 rounded-2xl w-32 h-32 flex flex-col items-center justify-center shadow-2xl relative ${gameState === 'running' ? 'animate-bounce' : ''}`}><span className="text-6xl font-serif font-black text-slate-900">{currentQ ? currentQ.char : '?'}</span>{gameState === 'bullet_time' && <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="absolute -top-14 bg-yellow-400 text-yellow-900 px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap shadow-lg border-2 border-yellow-500">{difficulty === 'beginner' ? 'ÊâæÈ¶ñÁ¢ºÔºÅ' : 'Ëß£Á¢ºÔºÅ'}</motion.div>}</div></motion.div></AnimatePresence></div></div>
                    </div>
                    <div className="flex-1 bg-white relative z-20 shadow-[0_-20px_60px_rgba(0,0,0,0.1)] rounded-t-[2.5rem] p-6 flex flex-col justify-start pt-12"><div className="absolute top-4 left-1/2 transform -translate-x-1/2 w-16 h-1.5 bg-slate-200 rounded-full"></div>{gameState === 'bullet_time' ? (<motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="w-full flex flex-col items-center"><h3 className={`font-bold mb-6 text-sm tracking-wider uppercase transition-colors duration-300 ${feedback?.includes('wrong') ? 'text-red-500 animate-pulse' : 'text-slate-400'}`}>{message || (difficulty === 'advanced' ? (userInput.length > 0 ? 'Ë´ãËº∏ÂÖ•Â∞æÁ¢º' : 'Ë´ãËº∏ÂÖ•È¶ñÁ¢º') : 'ÈÅ∏ÊìáÊ≠£Á¢∫ÈÉ®‰ª∂')}</h3>{renderOptions()}</motion.div>) : (<div className="h-full flex flex-col items-center justify-center text-slate-300"><div className="animate-pulse flex flex-col items-center"><LucideIcon icon={Rocket} size={48} className="mb-4 text-slate-200" /><span className="font-bold tracking-widest text-lg">Â•îË∑ë‰∏≠...</span></div></div>)}</div>
                </div>
            );
        };

        // --- üè† App Component ---
        const App = () => {
            const [view, setView] = useState('home'); 
            const [userName, setUserName] = useState('');
            const [saveData, setSaveData] = useState(null);
            const [config, setConfig] = useState({ difficulty: 'beginner', category: null, theme: THEMES.FOREST, mode: 'runner' });
            
            const [metaState, setMetaState] = useState({
                coins: 0,
                upgrades: { hp: 0, atk: 0, exp: 0 },
                unlockedArtifacts: ['wand_1', 'robe_1', 'ring_1', 'boots_1']
            });

            useEffect(() => {
                const saved = localStorage.getItem('speedy_adventure_meta');
                if (saved) { try { const parsed = JSON.parse(saved); setMetaState(parsed.metaState || metaState); setUserName(parsed.userName || ''); } catch(e) {} }
            }, []);

            useEffect(() => { localStorage.setItem('speedy_adventure_meta', JSON.stringify({ metaState, userName })); }, [metaState, userName]);

            const goHome = () => setView('home');
            const handleGameEnd = (coinsEarned) => { setMetaState(prev => ({ ...prev, coins: prev.coins + coinsEarned })); setView('mode_select'); };

            const handleExportSave = () => {
                const data = JSON.stringify({ metaState, userName, date: new Date().toISOString() });
                const blob = new Blob([data], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `word_battler_backup.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            };

            const handleImportSave = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.metaState) setMetaState(data.metaState);
                        if (data.userName) setUserName(data.userName);
                        alert("Â≠òÊ™îËÆÄÂèñÊàêÂäüÔºÅ");
                    } catch (err) { alert("ÁÑ°ÊïàÁöÑÂ≠òÊ™îÔºÅ"); }
                };
                reader.readAsText(file);
            };

            if (view === 'home') return ( <div className="h-full flex flex-col items-center justify-center bg-slate-900 p-6 text-white"><div className="bg-slate-800 p-8 rounded-3xl shadow-2xl text-center w-full max-w-md border border-slate-700"><LucideIcon icon={Rocket} size={64} className="text-magic-500 mx-auto mb-6" /><h1 className="text-4xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-magic-300 to-brand-300">ÈÄüÊàêÂ§ßÂÜíÈö™ V12</h1><p className="text-slate-400 mb-8">Roguelite Áü•Ë≠òÊ∑±Ê∑µ</p><input className="w-full p-4 bg-slate-900 border border-slate-600 rounded-xl text-center text-lg mb-6 text-white focus:border-magic-500 outline-none" placeholder="Âè¨ÂñöÂ∏´‰πãÂêç" value={userName} onChange={e=>setUserName(e.target.value)} /><button disabled={!userName} onClick={()=>{AudioEngine.click(); setView('mode_select')}} className="w-full bg-magic-600 hover:bg-magic-500 text-white p-4 rounded-xl font-bold shadow-lg disabled:opacity-50 transition-all flex items-center justify-center gap-2 mb-4"><LucideIcon icon={Play} /> ÈÄ≤ÂÖ•Ê∑±Ê∑µ</button><div className="flex gap-4 justify-center text-sm text-slate-500"><label className="cursor-pointer hover:text-magic-300 flex items-center gap-1"><LucideIcon icon={Upload} size={14}/> ËÆÄÂèñ <input type="file" className="hidden" onChange={handleImportSave}/></label><button onClick={handleExportSave} className="hover:text-magic-300 flex items-center gap-1"><LucideIcon icon={Download} size={14}/> ÂÇô‰ªΩ</button></div></div></div> );

            if (view === 'mode_select') return ( <div className="h-full bg-slate-950 p-6 overflow-y-auto text-white"><div className="flex justify-between items-center mb-8 max-w-4xl mx-auto"><div className="flex items-center gap-4"><div className="w-12 h-12 bg-magic-900 rounded-full flex items-center justify-center border border-magic-600"><LucideIcon icon={User} className="text-magic-300"/></div><div><h2 className="text-xl font-bold">{userName}</h2><div className="flex items-center gap-1 text-gold-400 text-sm"><LucideIcon icon={Coins} size={14}/> {metaState.coins}</div></div></div><button onClick={()=>setView('home')} className="p-2 bg-slate-800 rounded-full hover:bg-slate-700"><LucideIcon icon={Home} /></button></div><div className="grid gap-6 max-w-4xl mx-auto"><div onClick={()=>setView('meta_shop')} className="bg-gradient-to-r from-slate-900 to-magic-900 p-6 rounded-3xl border border-magic-500/30 cursor-pointer hover:scale-[1.02] transition-transform flex items-center justify-between"><div><h3 className="text-2xl font-bold text-gold-400 mb-1 flex items-center gap-2"><LucideIcon icon={ShoppingBag}/> Áü•Ë≠òËÅñÊÆø</h3><p className="text-slate-400 text-sm">Ê∂àËÄóÁü•Ë≠òÂπ£ÔºåÂº∑ÂåñËá™Ë∫´ËàáËß£ÈéñÈÅ∫Áâ©</p></div><LucideIcon icon={ArrowLeft} className="rotate-180 text-slate-500" /></div><div className="grid md:grid-cols-2 gap-6"><div className="bg-slate-800 p-6 rounded-3xl border border-slate-700 hover:border-magic-500 transition-colors"><LucideIcon icon={Sword} size={40} className="text-purple-400 mb-4" /><h3 className="text-2xl font-bold mb-2">Ê∑±Ê∑µË©¶ÁÖâ (RPG)</h3><p className="text-slate-400 text-sm mb-6">ÊåëÊà∞ÁÑ°ÈôêÂ±§Êï∏ÔºåRoguelite ÊàêÈï∑È´îÈ©ó„ÄÇ</p><div className="space-y-2">{['beginner', 'intermediate', 'advanced'].map(d => (<button key={d} onClick={()=>{setConfig({...config, mode: 'rpg', difficulty:d}); setView('category_select')}} className="w-full p-3 bg-slate-900 rounded-xl text-left border border-slate-700 hover:bg-magic-900/50 hover:border-magic-500 transition-colors flex justify-between items-center group"><span className="group-hover:text-magic-300">{d==='beginner'?'üü¢ Â≠∏Âæí':d==='intermediate'?'üü° Ê≥ïÂ∏´':'üî¥ Ë≥¢ËÄÖ'}</span><LucideIcon icon={Play} size={16} className="opacity-0 group-hover:opacity-100 transition-opacity"/></button>))}</div></div><div className="bg-white p-6 rounded-3xl border border-slate-200 text-slate-800"><LucideIcon icon={Zap} size={40} className="text-yellow-500 mb-4" /><h3 className="text-2xl font-bold mb-2">ÈÄüÊàêË∑ëÈÖ∑</h3><p className="text-slate-500 text-sm mb-6">ÂèçÊáâÂäõË®ìÁ∑¥ÔºÅ</p><div className="space-y-2">{['beginner', 'intermediate', 'advanced'].map(d => (<button key={d} onClick={()=>{setConfig({...config, mode: 'runner', difficulty:d}); setView('category_select')}} className="w-full p-3 bg-brand-50 rounded-xl text-left border border-brand-100 hover:bg-brand-100 transition-colors flex justify-between items-center group"><span className="group-hover:text-brand-600">{d==='beginner'?'üü¢ ÂàùÈöé':d==='intermediate'?'üü° ‰∏≠Èöé':'üî¥ È´òÈöé'}</span><LucideIcon icon={Play} size={16} className="opacity-0 group-hover:opacity-100 transition-opacity"/></button>))}</div></div></div></div></div> );

            if (view === 'meta_shop') return <MetaShop metaState={metaState} setMetaState={setMetaState} onBack={()=>setView('mode_select')} />;

            // Updated Category Select: Now Chapter Select
            if (view === 'category_select') return ( 
                <div className="h-full bg-slate-950 p-6 text-white overflow-y-auto">
                    <div className="flex justify-between items-center mb-8 max-w-4xl mx-auto"><h2 className="text-2xl font-bold">ÈÅ∏ÊìáÁ´†ÁØÄ (È¶ñÁ¢º)</h2><button onClick={()=>setView('mode_select')} className="p-2 bg-slate-800 rounded-full"><LucideIcon icon={ArrowLeft} /></button></div>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 max-w-4xl mx-auto">
                        <button onClick={() => { setConfig({...config, category: null}); setView(config.mode==='rpg'?'game_rpg':'game_runner'); }} className="p-4 bg-magic-900 border-2 border-magic-500 rounded-xl hover:bg-magic-800 transition-all flex flex-col items-center gap-2 col-span-full mb-4">
                            <span className="text-lg font-bold text-magic-300">Èö®Ê©üÊåëÊà∞ (ÊâÄÊúâÁ´†ÁØÄ)</span>
                        </button>
                        {CHAPTERS.map(chap => (
                            <button key={chap.id} onClick={()=>{setConfig({...config, category:chap.code}); setView(config.mode==='rpg'?'game_rpg':'game_runner')}} className="p-4 bg-slate-800 rounded-xl border border-slate-700 hover:border-brand-500 hover:bg-slate-700 transition-all flex flex-col items-center gap-1 group">
                                <div className="text-2xl font-black text-slate-500 group-hover:text-white">{chap.code}</div>
                                <div className="text-lg font-serif font-bold text-brand-400">{chap.name}</div>
                                <div className="text-xs text-slate-500 mt-1">Chapter {chap.id}</div>
                            </button>
                        ))}
                    </div>
                </div> 
            );

            if (view === 'game_rpg') return <RPGGame user={userName} difficulty={config.difficulty} chapter={config.category} metaState={metaState} onGameEnd={handleGameEnd} onExit={()=>setView('mode_select')} onHome={goHome} />;
            if (view === 'game_rpg_load') return <RPGGame user={userName} difficulty={config.difficulty} chapter={config.category} metaState={metaState} onGameEnd={handleGameEnd} onExit={()=>setView('mode_select')} onHome={goHome} initialData={saveData} />;
            if (view === 'game_runner') return <RunnerGame user={userName} difficulty={config.difficulty} chapter={config.category} onExit={()=>setView('category_select')} onHome={goHome} />;

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
